function e(e){return e&&e.__esModule?e.default:e}function s(e){return e.charAt(0).toUpperCase()+e.slice(1)}function i({uuid:e=null,scene_id:s=null,token_id:i=null,actor_id:a=null}){return e?fromUuidSync(e)||null:s&&i?game.scenes.get(s)?.tokens.get(i)?.actor||null:a&&game.actors.get(a)||null}function a(e){return e[Math.floor(Math.random()*e.length)]}class n extends Item{async prepareDerivedData(){super.prepareDerivedData(),this.full_name(),this.actor&&this.actor.isOwner&&this.id&&this.actor.items.get(this.id)&&this.parse_properties()}async _onCreate(e,s,i){await super._onCreate(e,s,i),this.isOwner&&this.id&&e.img===foundry.documents.BaseItem.DEFAULT_ICON&&("skill"===this.type&&this.update({img:"systems/saga-machine/images/defaults/skill.svg"}),"trait"===this.type&&this.update({img:"systems/saga-machine/images/defaults/trait.svg"}),"origin"===this.type&&this.update({img:"systems/saga-machine/images/defaults/origin.svg"}),"path"===this.type&&this.update({img:"systems/saga-machine/images/defaults/path.svg"}),"ambition"===this.type&&this.update({img:"systems/saga-machine/images/defaults/ambition.svg"}),"consequence"===this.type&&this.update({img:"systems/saga-machine/images/defaults/consequence.svg"}),"action"===this.type&&this.update({img:"systems/saga-machine/images/defaults/action.svg"}))}full_name(){let e=this.name+(this.system.specialized?` (${this.system.specialization})`:"");"trait"===this.type&&this.system.ranked&&(e+=` ${this.system.rank}`),this.system.full_name=e}parse_properties(){"item"===this.type&&("string"==typeof this.system.properties&&(this.system.properties=this.system.properties.split(",").map(e=>e.trim())),this.system.container=this.property_value("Container"),this.system.armor=this.property_value("Armor"),this.system.bulky=this.property_value("Bulky"),this.system.parry=this.property_value("Parry"),this.system.powered=this.property_value("Powered"),this.system.hands=this.property_value("Hands")||1,this.system.unit_encumbrance=o.calc_unit_encumbrance(this),this.system.container_encumbrance=o.calc_container_encumbrance(this),this.system.encumbrance=o.calc_encumbrance(this),this.system.unit_loads=o.calc_unit_loads(this),this.system.loads=o.calc_loads(this))}property_value(e){for(let s of this.system.properties)if(s.toLowerCase().startsWith(`${e.toLowerCase()} `)){let[e,i]=s.split(" ");return Number(i)}return 0}async remove_from_container(){"item"===this.type&&this.update({"system.parent":null})}}class r{static parent_action_index(e,s){let i=e?.system?.actions;if(!i)return -1;for(let e=0;e<i.length;e++)if(i[e]._id===s)return e;return -1}static is_power(e){return!!e.properties&&r.has_property(e.properties,"Power")}static is_attack(e){return"Defense"===e.tn||"Willpower"===e.tn}static strength_met(e,s=null){s||(s=i(e));let a=s?.system?.stats?.strength?.value;if(null==a)return!0;let n=r.damage(e),o=r.parse_properties(e.properties),l=r.property_value(o,"Light");return r.property_value(o,"Hands")>=2?a>=(l||n/2):a>=(l||n)}static damage(e){if(!e.effects)return 0;let s=JSON.parse(e.effects);Array.isArray(s)||(s=[s]);for(let e=0;e<s.length;e++){let i=new l(s[e]);if("damage"===i.type)return i.base_damage()}return 0}static is_defense(e){if(!e||!e.length)return!1;for(let s=0;s<e.length;s++)if("defense"===e[s].type)return!0;return!1}static merge_modifiers(e,s){return e=r.parse_properties(e),(s=r.parse_properties(s)).concat(e)}static merge_properties(e,s,i=!1){e=r.property_set(e);let a=[],n=(s=r.property_set(s)).concat(e).filter(e=>!(a.indexOf(e.property)>=0)&&!!a.push(e.property));return i?n.map(e=>`${e.property} ${e.value??""}`.trim()):n}static property_set(e){return r.parse_properties(e).map(e=>{let[s,i]=e.split(" ");return{property:s,value:Number(i)||null}})}static parse_properties(e){return"string"==typeof e?e.split(",").map(e=>e.trim()):Array.isArray(e)?e:[]}static property_value(e,s){for(let i of r.parse_properties(e))if(i.toLowerCase().startsWith(`${s.toLowerCase()} `)){let[,e]=i.split(" ");return Number(e)}return 0}static has_property(e,s){return r.parse_properties(e).map(e=>e.split(" ")[0]).includes(s)}}class o{static calc_unit_encumbrance(e){if(e.system.load)return 100;if(e.system.properties.includes("Neg"))return 0;for(let s of e.system.properties){if(s.startsWith("Implant ")||s.startsWith("Software "))return 0;if(s.startsWith("Big ")){let[e,i]=s.split(" ");return Number(i)}}return 1}static calc_unit_loads(e){return e.system.unit_encumbrance/100}static calc_container_encumbrance(e){return e.system.unit_encumbrance*e.system.quantity}static calc_encumbrance(e){return!e.system.carried||e.system.parent||e.system.equipped&&e.system.properties.includes("Worn")?0:e.system.unit_encumbrance*e.system.quantity}static calc_loads(e){return Math.floor(e.system.unit_loads*e.system.quantity)}}class l{test=null;type=null;target="self";when="always";message="";static IGNORES_ALL_ARMOR=-1;constructor(e,s=null){Object.assign(this,e),s&&(this.test=s),this.validate(e)}validate(){if(!["consequence","damage","defense","message"].includes(this.type))throw`Unknown type ${this.type}`}right_time(e){return"always"===this.when||this.when===e}format_message(e,s){return`<div><strong>${e}:</strong> ${s}</div>`}effect(){return"damage"===this.type?`${this.value} ${this.damage_type}`:"consequence"===this.type?this.name:"Special"}consequence_link(e=null){e||(e=this.name);let s=game.items.filter(s=>"consequence"===s.type&&s.name===e);return s&&s.length?`<a class="content-link" draggable="true" data-link="" data-uuid="${s[0].uuid}" data-id="${s[0].id}" data-type="Item" data-tooltip="Item"><i class="fas fa-suitcase"></i>${e}</a>`:e}base_damage(){let e=0,s=String(this.value).toLowerCase();return s.includes("@str")&&(e+=Number(this?.test?.actor?.system?.stats?.strength?.value)),s.includes("@dex")&&(e+=Number(this?.test?.actor?.system?.stats?.dexterity?.value)),s.includes("@spd")&&(e+=Number(this?.test?.actor?.system?.stats?.speed?.value)),s.includes("@end")&&(e+=Number(this?.test?.actor?.system?.stats?.endurance?.value)),s.includes("@int")&&(e+=Number(this?.test?.actor?.system?.stats?.intelligence?.value)),s.includes("@per")&&(e+=Number(this?.test?.actor?.system?.stats?.perception?.value)),s.includes("@chr")&&(e+=Number(this?.test?.actor?.system?.stats?.charisma?.value)),s.includes("@det")&&(e+=Number(this?.test?.actor?.system?.stats?.determination?.value)),e+=Number(s=s.replace(/[^\d.-]/g,""))}apply(e="always",s){return s||(s=this),"consequence"===this.type&&this.right_time(e)&&this.apply_consequence(),"damage"===this.type&&this.right_time(e)&&this.apply_damage(s),"defense"===this.type&&this.right_time(e)&&this.apply_defense(),"message"===this.type&&this.right_time(e)&&this.apply_message(),this}apply_message(){this.message=this.format_message(this.key?this.key:"Message",this.value)}apply_consequence(){let e=this.name?this.name:"Unknown",s=this.subject?`${e} (${this.subject})`:e,i=this.consequence_link(s);i||(i=s),this.message=this.format_message("Consequence",i)}apply_damage(e){let s=this.base_damage(),i=this.margin?Number(this.margin):this.test&&this.test.margin?Number(this.test.margin):0;this.properties=r.parse_properties(e.properties);let a=r.has_property(this.properties,"Ignores")?l.IGNORES_ALL_ARMOR:r.property_value(this.properties,"Pierce"),n=s+i;n<0&&(n=0),r.has_property(this.properties,"Feeble")&&(n=Math.floor(n/2));let o=this.damage_type?this.damage_type:"";this.message=this.format_message("Damage",`<span class="damage" data-pierce="${a}">${n}</span> <span class="damage-type">${o}</span>`)}apply_defense(){if(!this.test)return;let e=null;"self"===this.target?e=this.test.actor:"target"===this.target&&this.test.target&&(e=this.test.target);let s=e.system.scores.defense.value+this.test.randomizer,i=e.system.scores.willpower.value+this.test.randomizer;e.update({"system.scores.defense.tn":s,"system.scores.defense.roll":this.test.randomizer,"system.scores.defense.parry_on":!1,"system.scores.defense.dodge_on":!1,"system.scores.willpower.tn":i,"system.scores.willpower.roll":this.test.randomizer,"system.scores.willpower.resist_on":!1}),this.message=this.format_message("Defense",`TN ${s}`)+this.format_message("Willpower",`TN ${i}`)}static to_json(e){let s={};for(let[i,a]of Object.entries(e))("string"==typeof a||"number"==typeof a||"boolean"==typeof a||null===a||"properties"===i)&&(s[i]=a);return s}static from_json(e){return new l(e)}}class c{descriptor;description;constructor(e,s){this.descriptor=e||"",this.description=s||""}}class d{static async generate_wound(e,s){let i=new c;if(s&&"fat"!==e){let e=game.tables.getName("Grave Wounds");if(e)return i.description=(await e.draw()).results[0].text,i.descriptor=i.description.split(":")[0],i;i.descriptor=a(["grave ","deep ","severe ","critical ","serious ","major "])}switch("fat"!==e&&(i.descriptor+=a(["arm ","leg ","abdomen ","chest ","head ","neck ","hand ","foot ","knee ","elbow ","forearm ","shin ","side ","back ","cheek ","brow ","shoulder ","hip ","thigh ","groin ","rib ","skull ","face "])),e){case"burn":case"cor":case"fr":case"tox":i.descriptor+=a(["burn","sore","lesion"]);break;case"cut":i.descriptor+=a(["slash","cut","slice"]);break;case"fat":i.descriptor+=a(["tired","weakened","winded"]);break;case"pi":i.descriptor+=a(["stab","puncture","gash"]);break;case"sm":i.descriptor+=a(["bruise","trauma","rent"]);break;default:i.descriptor+=a(["wound","gash","laceration"])}return i}}const h={FAST_TURN:"3",NPC_TURN:"2",SLOW_TURN:"1"};class u extends Combatant{getInitiativeRoll(e){return this.actor?this.isNPC?this.actor.getInitiativeRoll(h.NPC_TURN):this.actor.getInitiativeRoll():new Roll(h.NPC_TURN)}getInitiativeValue(){return this.isNPC?Number(h.NPC_TURN):this.actor.system.fast_turn?Number(h.FAST_TURN):Number(h.SLOW_TURN)}}class p extends Combat{async rollInitiative(e,{formula:s=null,updateTurn:i=!0,messageOptions:a={}}={}){let n=[];for(let[i,a]of("string"==typeof e?[e]:e).entries()){let e=this.combatants.get(a);if(!e?.isOwner)continue;let i=e.getInitiativeRoll(s);await i.evaluate({async:!0}),n.push({_id:a,initiative:i.total})}return n.length&&(await this.updateEmbeddedDocuments("Combatant",n),i&&this.combatant?.id&&await this.update({turn:this.turns.findIndex(e=>e.id===this.combatant?.id)})),this}async update_combatant_initiative(e,s){if(null!=s)for(let s of game.combat.combatants.filter(s=>s.actorId===e.id))await game.combat.setInitiative(s.id,s.getInitiativeValue())}chase_label(e,s=!1){let i=s?e?.system?.scores?.willpower:e?.system?.scores?.defense;if(!i)return'<span class="defense-tn">&mdash;</span>';let a=e.system.scores.defense.roll,n="",r="";switch(a){case 1:n="critical failure",r="If this is a chase, the character encounters an obstacle.";break;case 9:case 10:n="critical success",r="If this is a chase, the character gains a leg up."}return`<span class="defense-tn ${n}" title="${r}">${i.tn}</span>`}async start_of_round(){new Dialog({title:"Begin New Round?",content:"<p>Do you want to begin a new round? Make sure to prompt your players to set their defenses first, if necessary.</p>",buttons:{Yes:{icon:"<i class='fas fa-check'></i>",label:"Yes",callback:async e=>{for(let e of(await this.rollAll(),this.combatants))"character"===e.actor.type&&await e.actor.test({stat:"defense",effects:[{type:"defense"}],whisper:!0,chat:!0,...e.actor.total_modifiers({score:"defense"})});let s=`<h3>Round ${this.round+1}</h3><p><strong>Choose a Fast or Slow turn now!</strong></p><table>`;for(let e of this.combatants){if(e.hidden)continue;let i=Array.from(e.actor.statuses.map(e=>e.split(/\s|-/).map(e=>e.capitalize()).join(" "))).sort().join(", ");s+=`<tr><td><strong>${e.name}</strong></td><td>${i||"&mdash;"}</td></tr>`}for(let e of(s+="</table>",await ChatMessage.create({content:s}),s="<h4><strong>Defenses This Round</strong></h4><table>",this.combatants))s+=`<tr><td><strong>${e.name}</strong></td><td>Defense ${this.chase_label(e.actor)}</td><td>Willpower ${this.chase_label(e.actor,!0)}</td></tr>`;for(let e of(s+="</table>",await ChatMessage.create({content:s,whisper:game.users.filter(e=>e.isGM).map(e=>e.id)}),this.combatants))e.actor.statuses.has("dying")&&!e.actor.statuses.has("defeated")&&(await ChatMessage.create({speaker:ChatMessage.getSpeaker({actor:e.actor}),content:`<p><strong>${e.name} is Dying!</strong></p><ul><li>Limited to 1 AP.</li><li>Making an Endurance test.<ul><li><em>Crit Success:</em> Lose a Dying.</li><li><em>Failure:</em> Gain a Dying.</li><li><em>3 Dying:</em> ${e.name} dies.</li></ul></li></ul>`}),await e.actor.test({stat:"endurance",tn:e.actor.dying_tn(),chat:!0,effects:[{type:"consequence",name:"Dying",when:"failure",target:"self"}],...e.actor.total_modifiers({score:"defense"})})),e.actor.statuses.has("bleeding")&&!e.actor.statuses.has("defeated")&&e.actor.items.filter(e=>"consequence"===e.type&&"Bleeding"===e.name).forEach(s=>{if(s.system.rank>0){let i=new l({type:"damage",value:s.system.rank,damage_type:s.system.specialization,properties:"Ignores",when:"always",target:"self"}).apply();ChatMessage.create({speaker:ChatMessage.getSpeaker({actor:e.actor}),content:`<p><strong>${e.name} is Bleeding!</strong></p><ul><li>Right-click and select Apply Damage.</li><li>${i.message}</li></ul>`})}})}},No:{icon:"<i class='fas fa-times'></i>",label:"No",callback:()=>{}}},default:"Yes"}).render(!0)}}class m extends CombatTracker{activateListeners(e){let s=this.viewed?.combatants;e.find(".combatant").each((e,i)=>{let a=i.getAttribute("data-combatant-id"),n=s.get(a);if(!n)return;let r=n.isNPC?"NPC":n.actor?.system?.fast_turn?"FAST":"SLOW";i.getElementsByClassName("token-initiative")[0].innerHTML=`<a class="combatant-control dlturnorder" title="Change Turn">${r}</a>`}),super.activateListeners(e),e.find(".dlturnorder").click(async e=>{let i=e.currentTarget.closest("li").dataset.combatantId,a=s.get(i);a&&!a.isNPC&&(game.user.isGM||a.actor.isOwner)&&(await a.actor.update({"system.fast_turn":!a.actor.system.fast_turn}),this.viewed&&this.viewed.setupTurns())})}}var g={};g=function(){function e(e,s){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);s&&(a=a.filter(function(s){return Object.getOwnPropertyDescriptor(e,s).enumerable})),i.push.apply(i,a)}return i}function s(s){for(var i=1;i<arguments.length;i++){var a=null!=arguments[i]?arguments[i]:{};i%2?e(Object(a),!0).forEach(function(e){!function(e,s,i){var a;(s="symbol"==typeof(a=function(e,s){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var a=i.call(e,s||"default");if("object"!=typeof a)return a;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===s?String:Number)(e)}(s,"string"))?a:String(a))in e?Object.defineProperty(e,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[s]=i}(s,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(a)):e(Object(a)).forEach(function(e){Object.defineProperty(s,e,Object.getOwnPropertyDescriptor(a,e))})}return s}let i=(e,s,i,a)=>(e=""+e,s=""+s,a&&(e=e.trim(),s=s.trim()),i?e==s:e.toLowerCase()==s.toLowerCase()),a=(e,s)=>e&&Array.isArray(e)&&e.map(e=>n(e,s));function n(e,s){var i,a={};for(i in e)0>s.indexOf(i)&&(a[i]=e[i]);return a}function r(e){var s=document.createElement("div");return e.replace(/\&#?[0-9a-z]+;/gi,function(e){return s.innerHTML=e,s.innerText})}function o(e){return(new DOMParser).parseFromString(e.trim(),"text/html").body.firstElementChild}function l(e,s){for(s=s||"previous";e=e[s+"Sibling"];)if(3==e.nodeType)return e}function c(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/`|'/g,"&#039;"):e}function d(e){var s=Object.prototype.toString.call(e).split(" ")[1].slice(0,-1);return e===Object(e)&&"Array"!=s&&"Function"!=s&&"RegExp"!=s&&"HTMLUnknownElement"!=s}function h(e,s,i){function a(e,s){for(var i in s)if(s.hasOwnProperty(i)){if(d(s[i])){d(e[i])?a(e[i],s[i]):e[i]=Object.assign({},s[i]);continue}if(Array.isArray(s[i])){e[i]=Object.assign([],s[i]);continue}e[i]=s[i]}}return e instanceof Object||(e={}),a(e,s),i&&a(e,i),e}function u(){let e=[],s={};for(let i of arguments)for(let a of i)d(a)?s[a.value]||(e.push(a),s[a.value]=1):e.includes(a)||e.push(a);return e}function p(e){return String.prototype.normalize?"string"==typeof e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,""):void 0:e}var m=()=>/(?=.*chrome)(?=.*android)/i.test(navigator.userAgent);function g(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}function f(e){return e&&e.classList&&e.classList.contains(this.settings.classNames.tag)}function y(e,s){var i=window.getSelection();return s=s||i.getRangeAt(0),"string"==typeof e&&(e=document.createTextNode(e)),s&&(s.deleteContents(),s.insertNode(e)),e}function v(e,s,i){return e?(s&&(e.__tagifyTagData=i?s:h({},e.__tagifyTagData||{},s)),e.__tagifyTagData):(console.warn("tag element doesn't exist",e,s),s)}function _(e){if(e&&e.parentNode){var s=window.getSelection(),i=s.getRangeAt(0);s.rangeCount&&(i.setStartAfter(e),i.collapse(!0),s.removeAllRanges(),s.addRange(i))}}function b(e,s){e.forEach(e=>{if(v(e.previousSibling)||!e.previousSibling){var i=document.createTextNode("​");e.before(i),s&&_(i)}})}var w={delimiters:",",pattern:null,tagTextProp:"value",maxTags:1/0,callbacks:{},addTagOnBlur:!0,onChangeAfterBlur:!0,duplicates:!1,whitelist:[],blacklist:[],enforceWhitelist:!1,userInput:!0,keepInvalidTags:!1,createInvalidTags:!0,mixTagsAllowedAfter:/,|\.|\:|\s/,mixTagsInterpolator:["[[","]]"],backspace:!0,skipInvalid:!1,pasteAsTags:!0,editTags:{clicks:2,keepInvalid:!0},transformTag:()=>{},trim:!0,a11y:{focusableTags:!1},mixMode:{insertAfterTag:" "},autoComplete:{enabled:!0,rightKey:!1},classNames:{namespace:"tagify",mixMode:"tagify--mix",selectMode:"tagify--select",input:"tagify__input",focus:"tagify--focus",tagNoAnimation:"tagify--noAnim",tagInvalid:"tagify--invalid",tagNotAllowed:"tagify--notAllowed",scopeLoading:"tagify--loading",hasMaxTags:"tagify--hasMaxTags",hasNoTags:"tagify--noTags",empty:"tagify--empty",inputInvalid:"tagify__input--invalid",dropdown:"tagify__dropdown",dropdownWrapper:"tagify__dropdown__wrapper",dropdownHeader:"tagify__dropdown__header",dropdownFooter:"tagify__dropdown__footer",dropdownItem:"tagify__dropdown__item",dropdownItemActive:"tagify__dropdown__item--active",dropdownItemHidden:"tagify__dropdown__item--hidden",dropdownInital:"tagify__dropdown--initial",tag:"tagify__tag",tagText:"tagify__tag-text",tagX:"tagify__tag__removeBtn",tagLoading:"tagify__tag--loading",tagEditing:"tagify__tag--editable",tagFlash:"tagify__tag--flash",tagHide:"tagify__tag--hide"},dropdown:{classname:"",enabled:2,maxItems:10,searchKeys:["value","searchBy"],fuzzySearch:!0,caseSensitive:!1,accentedSearch:!0,includeSelectedTags:!1,highlightFirst:!1,closeOnSelect:!0,clearOnSelect:!0,position:"all",appendTarget:null},hooks:{beforeRemoveTag:()=>Promise.resolve(),beforePaste:()=>Promise.resolve(),suggestionClick:()=>Promise.resolve()}};function T(){for(let e in this.dropdown={},this._dropdown)this.dropdown[e]="function"==typeof this._dropdown[e]?this._dropdown[e].bind(this):this._dropdown[e];this.dropdown.refs()}let k="@yaireo/tagify/";var x,D={empty:"empty",exceed:"number of tags exceeded",pattern:"pattern mismatch",duplicate:"already exists",notAllowed:"not allowed"};function O(e,s){var i;let a,n;if(!e){console.warn("Tagify:","input element not found",e);let s=new Proxy(this,{get:()=>()=>s});return s}if(e.__tagify)return console.warn("Tagify: ","input element is already Tagified - Same instance is returned.",e),e.__tagify;h(this,function(e){var s=document.createTextNode("");function i(e,i,a){a&&i.split(/\s+/g).forEach(i=>s[e+"EventListener"].call(s,i,a))}return{off(e,s){return i("remove",e,s),this},on(e,s){return s&&"function"==typeof s&&i("add",e,s),this},trigger(i,a,n){var r;if(n=n||{cloneData:!0},i){if(e.settings.isJQueryPlugin)"remove"==i&&(i="removeTag"),jQuery(e.DOM.originalInput).triggerHandler(i,[a]);else{try{var o="object"==typeof a?a:{value:a};if((o=n.cloneData?h({},o):o).tagify=this,a.event&&(o.event=this.cloneEvent(a.event)),a instanceof Object)for(var l in a)a[l]instanceof HTMLElement&&(o[l]=a[l]);r=new CustomEvent(i,{detail:o})}catch(e){console.warn(e)}s.dispatchEvent(r)}}}}}(this)),this.isFirefox=/firefox|fxios/i.test(navigator.userAgent)&&!/seamonkey/i.test(navigator.userAgent),this.isIE=window.document.documentMode,s=s||{},this.getPersistedData=(i=s.id,e=>{let s;if(1==localStorage.getItem(k+i+"/v",1))try{s=JSON.parse(localStorage[k+i+"/"+e])}catch(e){}return s}),this.setPersistedData=(a=s.id)?(localStorage.setItem(k+a+"/v",1),(e,s)=>{let i=JSON.stringify(e);e&&s&&(localStorage.setItem(k+a+"/"+s,i),dispatchEvent(new Event("storage")))}):()=>{},this.clearPersistedData=(n=s.id,e=>{let s=k+"/"+n+"/";if(e)localStorage.removeItem(s+e);else for(let e in localStorage)e.includes(s)&&localStorage.removeItem(e)}),this.applySettings(e,s),this.state={inputText:"",editing:!1,composing:!1,actions:{},mixMode:{},dropdown:{},flaggedTags:{}},this.value=[],this.listeners={},this.DOM={},this.build(e),T.call(this),this.getCSSVars(),this.loadOriginalValues(),this.events.customBinding.call(this),this.events.binding.call(this),e.autofocus&&this.DOM.input.focus(),e.__tagify=this}return O.prototype={_dropdown:{refs(){this.DOM.dropdown=this.parseTemplate("dropdown",[this.settings]),this.DOM.dropdown.content=this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-wrapper']")},getHeaderRef(){return this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-header']")},getFooterRef(){return this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-footer']")},getAllSuggestionsRefs(){return[...this.DOM.dropdown.content.querySelectorAll(this.settings.classNames.dropdownItemSelector)]},show(e){var s,a,n,r=this.settings,o="mix"==r.mode&&!r.enforceWhitelist,l=!r.whitelist||!r.whitelist.length,c="manual"==r.dropdown.position;if(e=void 0===e?this.state.inputText:e,!(l&&!o&&!r.templates.dropdownItemNoMatch||!1===r.dropdown.enable||this.state.isLoading||this.settings.readonly)){if(clearTimeout(this.dropdownHide__bindEventsTimeout),this.suggestedListItems=this.dropdown.filterListItems(e),e&&!this.suggestedListItems.length&&(this.trigger("dropdown:noMatch",e),r.templates.dropdownItemNoMatch&&(n=r.templates.dropdownItemNoMatch.call(this,{value:e}))),!n){if(this.suggestedListItems.length)e&&o&&!this.state.editing.scope&&!i(this.suggestedListItems[0].value,e)&&this.suggestedListItems.unshift({value:e});else{if(!e||!o||this.state.editing.scope)return this.input.autocomplete.suggest.call(this),void this.dropdown.hide();this.suggestedListItems=[{value:e}]}a=""+(d(s=this.suggestedListItems[0])?s.value:s),r.autoComplete&&a&&0==a.indexOf(e)&&this.input.autocomplete.suggest.call(this,s)}this.dropdown.fill(n),r.dropdown.highlightFirst&&this.dropdown.highlightOption(this.DOM.dropdown.content.querySelector(r.classNames.dropdownItemSelector)),this.state.dropdown.visible||setTimeout(this.dropdown.events.binding.bind(this)),this.state.dropdown.visible=e||!0,this.state.dropdown.query=e,this.setStateSelection(),c||setTimeout(()=>{this.dropdown.position(),this.dropdown.render()}),setTimeout(()=>{this.trigger("dropdown:show",this.DOM.dropdown)})}},hide(e){var s=this.DOM,i=s.scope,a=s.dropdown,n="manual"==this.settings.dropdown.position&&!e;if(a&&document.body.contains(a)&&!n)return window.removeEventListener("resize",this.dropdown.position),this.dropdown.events.binding.call(this,!1),i.setAttribute("aria-expanded",!1),a.parentNode.removeChild(a),setTimeout(()=>{this.state.dropdown.visible=!1},100),this.state.dropdown.query=this.state.ddItemData=this.state.ddItemElm=this.state.selection=null,this.state.tag&&this.state.tag.value.length&&(this.state.flaggedTags[this.state.tag.baseOffset]=this.state.tag),this.trigger("dropdown:hide",a),this},toggle(e){this.dropdown[this.state.dropdown.visible&&!e?"hide":"show"]()},render(){var e,s,i=((s=this.DOM.dropdown.cloneNode(!0)).style.cssText="position:fixed; top:-9999px; opacity:0",document.body.appendChild(s),e=s.clientHeight,s.parentNode.removeChild(s),e),a=this.settings;return"number"==typeof a.dropdown.enabled&&a.dropdown.enabled>=0&&(this.DOM.scope.setAttribute("aria-expanded",!0),document.body.contains(this.DOM.dropdown)||(this.DOM.dropdown.classList.add(a.classNames.dropdownInital),this.dropdown.position(i),a.dropdown.appendTarget.appendChild(this.DOM.dropdown),setTimeout(()=>this.DOM.dropdown.classList.remove(a.classNames.dropdownInital)))),this},fill(e){e="string"==typeof e?e:this.dropdown.createListHTML(e||this.suggestedListItems);var s=this.settings.templates.dropdownContent.call(this,e);this.DOM.dropdown.content.innerHTML=s?s.replace(/\>[\r\n ]+\</g,"><").split(/>\s+</).join("><").trim():""},fillHeaderFooter(){var e=this.dropdown.filterListItems(this.state.dropdown.query),s=this.parseTemplate("dropdownHeader",[e]),i=this.parseTemplate("dropdownFooter",[e]),a=this.dropdown.getHeaderRef(),n=this.dropdown.getFooterRef();s&&a?.parentNode.replaceChild(s,a),i&&n?.parentNode.replaceChild(i,n)},refilter(e){e=e||this.state.dropdown.query||"",this.suggestedListItems=this.dropdown.filterListItems(e),this.dropdown.fill(),this.suggestedListItems.length||this.dropdown.hide(),this.trigger("dropdown:updated",this.DOM.dropdown)},position(e){var s=this.settings.dropdown;if("manual"!=s.position){var i,a,n,r,o,l,c=this.DOM.dropdown,d=s.placeAbove,h=s.appendTarget===document.body,u=h?window.pageYOffset:s.appendTarget.scrollTop,p=document.fullscreenElement||document.webkitFullscreenElement||document.documentElement,m=p.clientHeight,g=Math.max(p.clientWidth||0,window.innerWidth||0)>480?s.position:"all",f=this.DOM["input"==g?"input":"scope"];if(e=e||c.clientHeight,this.state.dropdown.visible){if("text"==g?(n=(i=function(){let e=document.getSelection();if(e.rangeCount){let s,i;let a=e.getRangeAt(0),n=a.startContainer,r=a.startOffset;if(r>0)return(i=document.createRange()).setStart(n,r-1),i.setEnd(n,r),{left:(s=i.getBoundingClientRect()).right,top:s.top,bottom:s.bottom};if(n.getBoundingClientRect)return n.getBoundingClientRect()}return{left:-9999,top:-9999}}()).bottom,a=i.top,r=i.left,o="auto"):(l=function(e){for(var s=0,i=0;e&&e!=p;)s+=e.offsetLeft||0,i+=e.offsetTop||0,e=e.parentNode;return{left:s,top:i}}(s.appendTarget),a=(i=f.getBoundingClientRect()).top-l.top,n=i.bottom-1-l.top,r=i.left-l.left,o=i.width+"px"),!h){let e=function(){for(var e=0,i=s.appendTarget.parentNode;i;)e+=i.scrollTop||0,i=i.parentNode;return e}();a+=e,n+=e}a=Math.floor(a),n=Math.ceil(n),d=void 0===d?m-i.bottom<e:d,c.style.cssText="left:"+(r+window.pageXOffset)+"px; width:"+o+";"+(d?"top: "+(a+u)+"px":"top: "+(n+u)+"px"),c.setAttribute("placement",d?"top":"bottom"),c.setAttribute("position",g)}}},events:{binding(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var s=this.dropdown.events.callbacks,i=this.listeners.dropdown=this.listeners.dropdown||{position:this.dropdown.position.bind(this,null),onKeyDown:s.onKeyDown.bind(this),onMouseOver:s.onMouseOver.bind(this),onMouseLeave:s.onMouseLeave.bind(this),onClick:s.onClick.bind(this),onScroll:s.onScroll.bind(this)},a=e?"addEventListener":"removeEventListener";"manual"!=this.settings.dropdown.position&&(document[a]("scroll",i.position,!0),window[a]("resize",i.position),window[a]("keydown",i.onKeyDown)),this.DOM.dropdown[a]("mouseover",i.onMouseOver),this.DOM.dropdown[a]("mouseleave",i.onMouseLeave),this.DOM.dropdown[a]("mousedown",i.onClick),this.DOM.dropdown.content[a]("scroll",i.onScroll)},callbacks:{onKeyDown(e){if(this.state.hasFocus&&!this.state.composing){var s=this.DOM.dropdown.querySelector(this.settings.classNames.dropdownItemActiveSelector),i=this.dropdown.getSuggestionDataByNode(s);switch(e.key){case"ArrowDown":case"ArrowUp":case"Down":case"Up":e.preventDefault();var a=this.dropdown.getAllSuggestionsRefs(),n="ArrowUp"==e.key||"Up"==e.key;s&&(s=this.dropdown.getNextOrPrevOption(s,!n)),s&&s.matches(this.settings.classNames.dropdownItemSelector)||(s=a[n?a.length-1:0]),this.dropdown.highlightOption(s,!0);break;case"Escape":case"Esc":this.dropdown.hide();break;case"ArrowRight":if(this.state.actions.ArrowLeft)return;case"Tab":if("mix"!=this.settings.mode&&s&&!this.settings.autoComplete.rightKey&&!this.state.editing){e.preventDefault();var r=this.dropdown.getMappedValue(i);return this.input.autocomplete.set.call(this,r),!1}return!0;case"Enter":e.preventDefault(),this.settings.hooks.suggestionClick(e,{tagify:this,tagData:i,suggestionElm:s}).then(()=>{if(s)return this.dropdown.selectOption(s),s=this.dropdown.getNextOrPrevOption(s,!n),void this.dropdown.highlightOption(s);this.dropdown.hide(),"mix"!=this.settings.mode&&this.addTags(this.state.inputText.trim(),!0)}).catch(e=>e);break;case"Backspace":{if("mix"==this.settings.mode||this.state.editing.scope)return;let e=this.input.raw.call(this);""!=e&&8203!=e.charCodeAt(0)||(!0===this.settings.backspace?this.removeTags():"edit"==this.settings.backspace&&setTimeout(this.editTag.bind(this),0))}}}},onMouseOver(e){var s=e.target.closest(this.settings.classNames.dropdownItemSelector);s&&this.dropdown.highlightOption(s)},onMouseLeave(e){this.dropdown.highlightOption()},onClick(e){if(0==e.button&&e.target!=this.DOM.dropdown&&e.target!=this.DOM.dropdown.content){var s=e.target.closest(this.settings.classNames.dropdownItemSelector),i=this.dropdown.getSuggestionDataByNode(s);this.state.actions.selectOption=!0,setTimeout(()=>this.state.actions.selectOption=!1,50),this.settings.hooks.suggestionClick(e,{tagify:this,tagData:i,suggestionElm:s}).then(()=>{s?this.dropdown.selectOption(s,e):this.dropdown.hide()}).catch(e=>console.warn(e))}},onScroll(e){var s=e.target,i=s.scrollTop/(s.scrollHeight-s.parentNode.clientHeight)*100;this.trigger("dropdown:scroll",{percentage:Math.round(i)})}}},getSuggestionDataByNode(e){var s=e&&e.getAttribute("value");return this.suggestedListItems.find(e=>e.value==s)||null},getNextOrPrevOption(e){let s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var i=this.dropdown.getAllSuggestionsRefs(),a=i.findIndex(s=>s===e);return s?i[a+1]:i[a-1]},highlightOption(e,s){var i,a=this.settings.classNames.dropdownItemActive;if(this.state.ddItemElm&&(this.state.ddItemElm.classList.remove(a),this.state.ddItemElm.removeAttribute("aria-selected")),!e)return this.state.ddItemData=null,this.state.ddItemElm=null,void this.input.autocomplete.suggest.call(this);i=this.dropdown.getSuggestionDataByNode(e),this.state.ddItemData=i,this.state.ddItemElm=e,e.classList.add(a),e.setAttribute("aria-selected",!0),s&&(e.parentNode.scrollTop=e.clientHeight+e.offsetTop-e.parentNode.clientHeight),this.settings.autoComplete&&(this.input.autocomplete.suggest.call(this,i),this.dropdown.position())},selectOption(e,s){var i=this.settings.dropdown,a=i.clearOnSelect,n=i.closeOnSelect;if(!e)return this.addTags(this.state.inputText,!0),void(n&&this.dropdown.hide());s=s||{};var r=e.getAttribute("value"),o=this.suggestedListItems.find(e=>(e.value??e)==r);this.trigger("dropdown:select",{data:o,elm:e,event:s}),r&&(o||"noMatch"==r)?(this.state.editing?this.onEditTagDone(null,h({__isValid:!0},this.normalizeTags([o])[0])):this["mix"==this.settings.mode?"addMixTags":"addTags"]([o||this.input.raw.call(this)],a),this.DOM.input.parentNode&&(setTimeout(()=>{this.DOM.input.focus(),this.toggleFocusClass(!0)}),n&&setTimeout(this.dropdown.hide.bind(this)),e.addEventListener("transitionend",()=>{this.dropdown.fillHeaderFooter(),setTimeout(()=>e.remove(),100)},{once:!0}),e.classList.add(this.settings.classNames.dropdownItemHidden))):n&&setTimeout(this.dropdown.hide.bind(this))},selectAll(e){this.suggestedListItems.length=0,this.dropdown.hide(),this.dropdown.filterListItems("");var s=this.dropdown.filterListItems("");return e||(s=this.state.dropdown.suggestions),this.addTags(s,!0),this},filterListItems(e,s){var i,a,n,r,o,l=this.settings,c=l.dropdown,h=(s=s||{},[]),u=[],m=l.whitelist,g=c.maxItems>=0?c.maxItems:1/0,f=c.searchKeys,y=0;if(!(e="select"==l.mode&&this.value.length&&this.value[0][l.tagTextProp]==e?"":e)||!f.length)return h=c.includeSelectedTags?m:m.filter(e=>!this.isTagDuplicate(d(e)?e.value:e)),this.state.dropdown.suggestions=h,h.slice(0,g);for(o=c.caseSensitive?""+e:(""+e).toLowerCase();y<m.length;y++){let e,l;let g=Object.keys(i=m[y]instanceof Object?m[y]:{value:m[y]}).some(e=>f.includes(e))?f:["value"];c.fuzzySearch&&!s.exact?(n=g.reduce((e,s)=>e+" "+(i[s]||""),"").toLowerCase().trim(),c.accentedSearch&&(n=p(n),o=p(o)),e=0==n.indexOf(o),l=n===o,a=function(e,s){return s.toLowerCase().split(" ").every(s=>e.includes(s.toLowerCase()))}(n,o)):(e=!0,a=g.some(e=>{var a=""+(i[e]||"");return c.accentedSearch&&(a=p(a),o=p(o)),c.caseSensitive||(a=a.toLowerCase()),l=a===o,s.exact?a===o:0==a.indexOf(o)})),r=!c.includeSelectedTags&&this.isTagDuplicate(d(i)?i.value:i),a&&!r&&(l&&e?u.push(i):"startsWith"==c.sortby&&e?h.unshift(i):h.push(i))}return this.state.dropdown.suggestions=u.concat(h),"function"==typeof c.sortby?c.sortby(u.concat(h),o):u.concat(h).slice(0,g)},getMappedValue(e){var s=this.settings.dropdown.mapValueTo;return s?"function"==typeof s?s(e):e[s]||e.value:e.value},createListHTML(e){return h([],e).map((e,i)=>{"string"!=typeof e&&"number"!=typeof e||(e={value:e});var a=this.dropdown.getMappedValue(e);return a="string"==typeof a?c(a):a,this.settings.templates.dropdownItem.apply(this,[s(s({},e),{},{mappedValue:a}),this])}).join("")}},getSetTagData:v,helpers:{sameStr:i,removeCollectionProp:a,omit:n,isObject:d,parseHTML:o,escapeHTML:c,extend:h,concatWithoutDups:u,getUID:g,isNodeTag:f},customEventsList:["change","add","remove","invalid","input","click","keydown","focus","blur","edit:input","edit:beforeUpdate","edit:updated","edit:start","edit:keydown","dropdown:show","dropdown:hide","dropdown:select","dropdown:updated","dropdown:noMatch","dropdown:scroll"],dataProps:["__isValid","__removed","__originalData","__originalHTML","__tagId"],trim(e){return this.settings.trim&&e&&"string"==typeof e?e.trim():e},parseHTML:o,templates:{wrapper:(e,s)=>`<tags class="${s.classNames.namespace} ${s.mode?`${s.classNames[s.mode+"Mode"]}`:""} ${e.className}"
                    ${s.readonly?"readonly":""}
                    ${s.disabled?"disabled":""}
                    ${s.required?"required":""}
                    ${"select"===s.mode?"spellcheck='false'":""}
                    tabIndex="-1">
            <span ${!s.readonly&&s.userInput?"contenteditable":""} tabIndex="0" data-placeholder="${s.placeholder||"&#8203;"}" aria-placeholder="${s.placeholder||""}"
                class="${s.classNames.input}"
                role="textbox"
                aria-autocomplete="both"
                aria-multiline="${"mix"==s.mode}"></span>
                &#8203;
        </tags>`,tag(e,s){let i=s.settings;return`<tag title="${e.title||e.value}"
                    contenteditable='false'
                    spellcheck='false'
                    tabIndex="${i.a11y.focusableTags?0:-1}"
                    class="${i.classNames.tag} ${e.class||""}"
                    ${this.getAttributes(e)}>
            <x title='' class="${i.classNames.tagX}" role='button' aria-label='remove tag'></x>
            <div>
                <span class="${i.classNames.tagText}">${e[i.tagTextProp]||e.value}</span>
            </div>
        </tag>`},dropdown(e){var s=e.dropdown,i="manual"==s.position,a=`${e.classNames.dropdown}`;return`<div class="${i?"":a} ${s.classname}" role="listbox" aria-labelledby="dropdown">
                    <div data-selector='tagify-suggestions-wrapper' class="${e.classNames.dropdownWrapper}"></div>
                </div>`},dropdownContent(e){var s=this.settings,i=this.state.dropdown.suggestions;return`
            ${s.templates.dropdownHeader.call(this,i)}
            ${e}
            ${s.templates.dropdownFooter.call(this,i)}
        `},dropdownItem(e){return`<div ${this.getAttributes(e)}
                    class='${this.settings.classNames.dropdownItem} ${e.class?e.class:""}'
                    tabindex="0"
                    role="option">${e.mappedValue||e.value}</div>`},dropdownHeader(e){return`<header data-selector='tagify-suggestions-header' class="${this.settings.classNames.dropdownHeader}"></header>`},dropdownFooter(e){var s=e.length-this.settings.dropdown.maxItems;return s>0?`<footer data-selector='tagify-suggestions-footer' class="${this.settings.classNames.dropdownFooter}">
                ${s} more items. Refine your search.
            </footer>`:""},dropdownItemNoMatch:null},parseTemplate(e,s){return o((e=this.settings.templates[e]||e).apply(this,s))},set whitelist(t){let e=t&&Array.isArray(t);this.settings.whitelist=e?t:[],this.setPersistedData(e?t:[],"whitelist")},get whitelist(){return this.settings.whitelist},generateClassSelectors(e){for(let s in e){let i=s;Object.defineProperty(e,i+"Selector",{get(){return"."+this[i].split(" ")[0]}})}},applySettings(e,i){w.templates=this.templates;var a=h({},w,"mix"==i.mode?{dropdown:{position:"text"}}:{}),n=this.settings=h({},a,i);if(n.disabled=e.hasAttribute("disabled"),n.readonly=n.readonly||e.hasAttribute("readonly"),n.placeholder=c(e.getAttribute("placeholder")||n.placeholder||""),n.required=e.hasAttribute("required"),this.generateClassSelectors(n.classNames),void 0===n.dropdown.includeSelectedTags&&(n.dropdown.includeSelectedTags=n.duplicates),this.isIE&&(n.autoComplete=!1),["whitelist","blacklist"].forEach(s=>{var i=e.getAttribute("data-"+s);i&&(i=i.split(n.delimiters))instanceof Array&&(n[s]=i)}),"autoComplete"in i&&!d(i.autoComplete)&&(n.autoComplete=w.autoComplete,n.autoComplete.enabled=i.autoComplete),"mix"==n.mode&&(n.pattern=n.pattern||/@/,n.autoComplete.rightKey=!0,n.delimiters=i.delimiters||null,n.tagTextProp&&!n.dropdown.searchKeys.includes(n.tagTextProp)&&n.dropdown.searchKeys.push(n.tagTextProp)),e.pattern)try{n.pattern=new RegExp(e.pattern)}catch(e){}if(n.delimiters){n._delimiters=n.delimiters;try{n.delimiters=RegExp(this.settings.delimiters,"g")}catch(e){}}n.disabled&&(n.userInput=!1),this.TEXTS=s(s({},D),n.texts||{}),("select"!=n.mode||i.dropdown?.enabled)&&n.userInput||(n.dropdown.enabled=0),n.dropdown.appendTarget=i.dropdown?.appendTarget||document.body;let r=this.getPersistedData("whitelist");Array.isArray(r)&&(this.whitelist=Array.isArray(n.whitelist)?u(n.whitelist,r):r)},getAttributes(e){var s,i=this.getCustomAttributes(e),a="";for(s in i)a+=" "+s+(void 0!==e[s]?`="${i[s]}"`:"");return a},getCustomAttributes(e){if(!d(e))return"";var s,i={};for(s in e)"__"!=s.slice(0,2)&&"class"!=s&&e.hasOwnProperty(s)&&void 0!==e[s]&&(i[s]=c(e[s]));return i},setStateSelection(){var e=window.getSelection(),s={anchorOffset:e.anchorOffset,anchorNode:e.anchorNode,range:e.getRangeAt&&e.rangeCount&&e.getRangeAt(0)};return this.state.selection=s,s},getCSSVars(){let e;var s,i,a=getComputedStyle(this.DOM.scope,null);this.CSSVars={tagHideTransition:(e=(s=function(e){if(!e)return{};var s=(e=e.trim().split(" ")[0]).split(/\d+/g).filter(e=>e).pop().trim();return{value:+e.split(s).filter(e=>e)[0].trim(),unit:s}}((i="tag-hide-transition",a.getPropertyValue("--"+i)))).value,"s"==s.unit?1e3*e:e)}},build(e){var s=this.DOM;this.settings.mixMode.integrated?(s.originalInput=null,s.scope=e,s.input=e):(s.originalInput=e,s.originalInput_tabIndex=e.tabIndex,s.scope=this.parseTemplate("wrapper",[e,this.settings]),s.input=s.scope.querySelector(this.settings.classNames.inputSelector),e.parentNode.insertBefore(s.scope,e),e.tabIndex=-1)},destroy(){this.events.unbindGlobal.call(this),this.DOM.scope.parentNode.removeChild(this.DOM.scope),this.DOM.originalInput.tabIndex=this.DOM.originalInput_tabIndex,delete this.DOM.originalInput.__tagify,this.dropdown.hide(!0),clearTimeout(this.dropdownHide__bindEventsTimeout),clearInterval(this.listeners.main.originalInputValueObserverInterval)},loadOriginalValues(e){var s,i=this.settings;if(this.state.blockChangeEvent=!0,void 0===e){let s=this.getPersistedData("value");e=s&&!this.DOM.originalInput.value?s:i.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value}if(this.removeAllTags(),e){if("mix"==i.mode)this.parseMixTags(e),(s=this.DOM.input.lastChild)&&"BR"==s.tagName||this.DOM.input.insertAdjacentHTML("beforeend","<br>");else{try{JSON.parse(e) instanceof Array&&(e=JSON.parse(e))}catch(e){}this.addTags(e,!0).forEach(e=>e&&e.classList.add(i.classNames.tagNoAnimation))}}else this.postUpdate();this.state.lastOriginalValueReported=i.mixMode.integrated?"":this.DOM.originalInput.value},cloneEvent(e){var s={};for(var i in e)"path"!=i&&(s[i]=e[i]);return s},loading(e){return this.state.isLoading=e,this.DOM.scope.classList[e?"add":"remove"](this.settings.classNames.scopeLoading),this},tagLoading(e,s){return e&&e.classList[s?"add":"remove"](this.settings.classNames.tagLoading),this},toggleClass(e,s){"string"==typeof e&&this.DOM.scope.classList.toggle(e,s)},toggleScopeValidation(e){var s=!0===e||void 0===e;!this.settings.required&&e&&e===this.TEXTS.empty&&(s=!0),this.toggleClass(this.settings.classNames.tagInvalid,!s),this.DOM.scope.title=s?"":e},toggleFocusClass(e){this.toggleClass(this.settings.classNames.focus,!!e)},triggerChangeEvent:function(){if(!this.settings.mixMode.integrated){var e=this.DOM.originalInput,s=this.state.lastOriginalValueReported!==e.value,i=new CustomEvent("change",{bubbles:!0});s&&(this.state.lastOriginalValueReported=e.value,i.simulated=!0,e._valueTracker&&e._valueTracker.setValue(Math.random()),e.dispatchEvent(i),this.trigger("change",this.state.lastOriginalValueReported),e.value=this.state.lastOriginalValueReported)}},events:{customBinding(){this.customEventsList.forEach(e=>{this.on(e,this.settings.callbacks[e])})},binding(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var s,i=this.events.callbacks,a=e?"addEventListener":"removeEventListener";if(!this.state.mainEvents||!e){for(var n in this.state.mainEvents=e,e&&!this.listeners.main&&(this.events.bindGlobal.call(this),this.settings.isJQueryPlugin&&jQuery(this.DOM.originalInput).on("tagify.removeAllTags",this.removeAllTags.bind(this))),s=this.listeners.main=this.listeners.main||{focus:["input",i.onFocusBlur.bind(this)],keydown:["input",i.onKeydown.bind(this)],click:["scope",i.onClickScope.bind(this)],dblclick:["scope",i.onDoubleClickScope.bind(this)],paste:["input",i.onPaste.bind(this)],drop:["input",i.onDrop.bind(this)],compositionstart:["input",i.onCompositionStart.bind(this)],compositionend:["input",i.onCompositionEnd.bind(this)]})this.DOM[s[n][0]][a](n,s[n][1]);clearInterval(this.listeners.main.originalInputValueObserverInterval),this.listeners.main.originalInputValueObserverInterval=setInterval(i.observeOriginalInputValue.bind(this),500);var r=this.listeners.main.inputMutationObserver||new MutationObserver(i.onInputDOMChange.bind(this));r.disconnect(),"mix"==this.settings.mode&&r.observe(this.DOM.input,{childList:!0})}},bindGlobal(e){var s,i=this.events.callbacks,a=e?"removeEventListener":"addEventListener";if(this.listeners&&(e||!this.listeners.global))for(s of(this.listeners.global=this.listeners.global||[{type:this.isIE?"keydown":"input",target:this.DOM.input,cb:i[this.isIE?"onInputIE":"onInput"].bind(this)},{type:"keydown",target:window,cb:i.onWindowKeyDown.bind(this)},{type:"blur",target:this.DOM.input,cb:i.onFocusBlur.bind(this)},{type:"click",target:document,cb:i.onClickAnywhere.bind(this)}],this.listeners.global))s.target[a](s.type,s.cb)},unbindGlobal(){this.events.bindGlobal.call(this,!0)},callbacks:{onFocusBlur(e){var s=this.settings,i=e.target?this.trim(e.target.textContent):"",a=this.value?.[0]?.[s.tagTextProp],n=e.type,r=s.dropdown.enabled>=0,o={relatedTarget:e.relatedTarget},l=this.state.actions.selectOption&&(r||!s.dropdown.closeOnSelect),c=this.state.actions.addNew&&r,d=e.relatedTarget&&f.call(this,e.relatedTarget)&&this.DOM.scope.contains(e.relatedTarget);if("blur"==n){if(e.relatedTarget===this.DOM.scope)return this.dropdown.hide(),void this.DOM.input.focus();this.postUpdate(),s.onChangeAfterBlur&&this.triggerChangeEvent()}if(!l&&!c){if(this.state.hasFocus="focus"==n&&+new Date,this.toggleFocusClass(this.state.hasFocus),"mix"!=s.mode){if("focus"==n)return this.trigger("focus",o),void(0!==s.dropdown.enabled&&s.userInput||this.dropdown.show(this.value.length?"":void 0));"blur"==n&&(this.trigger("blur",o),this.loading(!1),"select"==s.mode&&(d&&(this.removeTags(),i=""),a===i&&(i="")),i&&!this.state.actions.selectOption&&s.addTagOnBlur&&this.addTags(i,!0)),this.DOM.input.removeAttribute("style"),this.dropdown.hide()}else"focus"==n?this.trigger("focus",o):"blur"==e.type&&(this.trigger("blur",o),this.loading(!1),this.dropdown.hide(),this.state.dropdown.visible=void 0,this.setStateSelection())}},onCompositionStart(e){this.state.composing=!0},onCompositionEnd(e){this.state.composing=!1},onWindowKeyDown(e){var s,i=document.activeElement,a=f.call(this,i)&&this.DOM.scope.contains(document.activeElement),n=a&&i.hasAttribute("readonly");if(a&&!n)switch(s=i.nextElementSibling,e.key){case"Backspace":this.settings.readonly||(this.removeTags(i),(s||this.DOM.input).focus());break;case"Enter":setTimeout(this.editTag.bind(this),0,i)}},onKeydown(e){var s=this.settings;if(!this.state.composing&&s.userInput){"select"==s.mode&&s.enforceWhitelist&&this.value.length&&"Tab"!=e.key&&e.preventDefault();var i=this.trim(e.target.textContent);if(this.trigger("keydown",{event:e}),"mix"==s.mode){switch(e.key){case"Left":case"ArrowLeft":this.state.actions.ArrowLeft=!0;break;case"Delete":case"Backspace":if(this.state.editing)return;var a=document.getSelection(),n="Delete"==e.key&&a.anchorOffset==(a.anchorNode.length||0),o=a.anchorNode.previousSibling,c=1==a.anchorNode.nodeType||!a.anchorOffset&&o&&1==o.nodeType&&a.anchorNode.previousSibling;r(this.DOM.input.innerHTML);var d,h,u,p=this.getTagElms(),g=1===a.anchorNode.length&&a.anchorNode.nodeValue==String.fromCharCode(8203);if("edit"==s.backspace&&c)return d=1==a.anchorNode.nodeType?null:a.anchorNode.previousElementSibling,setTimeout(this.editTag.bind(this),0,d),void e.preventDefault();if(m()&&c instanceof Element)return u=l(c),c.hasAttribute("readonly")||c.remove(),this.DOM.input.focus(),void setTimeout(()=>{_(u),this.DOM.input.click()});if("BR"==a.anchorNode.nodeName)return;if((n||c)&&1==a.anchorNode.nodeType?h=0==a.anchorOffset?n?p[0]:null:p[Math.min(p.length,a.anchorOffset)-1]:n?h=a.anchorNode.nextElementSibling:c instanceof Element&&(h=c),3==a.anchorNode.nodeType&&!a.anchorNode.nodeValue&&a.anchorNode.previousElementSibling&&e.preventDefault(),(c||n)&&!s.backspace||"Range"!=a.type&&!a.anchorOffset&&a.anchorNode==this.DOM.input&&"Delete"!=e.key)return void e.preventDefault();if("Range"!=a.type&&h&&h.hasAttribute("readonly"))return void _(l(h));"Delete"==e.key&&g&&v(a.anchorNode.nextSibling)&&this.removeTags(a.anchorNode.nextSibling),clearTimeout(x),x=setTimeout(()=>{var e=document.getSelection();r(this.DOM.input.innerHTML),n||e.anchorNode.previousSibling,this.value=[].map.call(p,(e,s)=>{var i=v(e);if(e.parentNode||i.readonly)return i;this.trigger("remove",{tag:e,index:s,data:i})}).filter(e=>e)},20)}return!0}switch(e.key){case"Backspace":"select"==s.mode&&s.enforceWhitelist&&this.value.length?this.removeTags():this.state.dropdown.visible&&"manual"!=s.dropdown.position||""!=e.target.textContent&&8203!=i.charCodeAt(0)||(!0===s.backspace?this.removeTags():"edit"==s.backspace&&setTimeout(this.editTag.bind(this),0));break;case"Esc":case"Escape":if(this.state.dropdown.visible)return;e.target.blur();break;case"Down":case"ArrowDown":this.state.dropdown.visible||this.dropdown.show();break;case"ArrowRight":{let e=this.state.inputSuggestion||this.state.ddItemData;if(e&&s.autoComplete.rightKey)return void this.addTags([e],!0);break}case"Tab":{let a="select"==s.mode;if(!i||a)return!0;e.preventDefault()}case"Enter":if(this.state.dropdown.visible&&"manual"!=s.dropdown.position)return;e.preventDefault(),setTimeout(()=>{this.state.dropdown.visible||this.state.actions.selectOption||this.addTags(i,!0)})}}},onInput(e){this.postUpdate();var s=this.settings;if("mix"==s.mode)return this.events.callbacks.onMixTagsInput.call(this,e);var i=this.input.normalize.call(this),a=i.length>=s.dropdown.enabled,n={value:i,inputElm:this.DOM.input},r=this.validateTag({value:i});"select"==s.mode&&this.toggleScopeValidation(r),n.isValid=r,this.state.inputText!=i&&(this.input.set.call(this,i,!1),-1!=i.search(s.delimiters)?this.addTags(i)&&this.input.set.call(this):s.dropdown.enabled>=0&&this.dropdown[a?"show":"hide"](i),this.trigger("input",n))},onMixTagsInput(e){var s,i,a,n,r,o,l,c,d=this.settings,u=this.value.length,p=this.getTagElms(),g=document.createDocumentFragment(),f=window.getSelection().getRangeAt(0),y=[].map.call(p,e=>v(e).value);if("deleteContentBackward"==e.inputType&&m()&&this.events.callbacks.onKeydown.call(this,{target:e.target,key:"Backspace"}),b(this.getTagElms()),this.value.slice().forEach(e=>{e.readonly&&!y.includes(e.value)&&g.appendChild(this.createTagElem(e))}),g.childNodes.length&&(f.insertNode(g),this.setRangeAtStartEnd(!1,g.lastChild)),p.length!=u)return this.value=[].map.call(this.getTagElms(),e=>v(e)),void this.update({withoutChangeEvent:!0});if(this.hasMaxTags())return!0;if(window.getSelection&&(o=window.getSelection()).rangeCount>0&&3==o.anchorNode.nodeType){if((f=o.getRangeAt(0).cloneRange()).collapse(!0),f.setStart(o.focusNode,0),a=(s=f.toString().slice(0,f.endOffset)).split(d.pattern).length-1,(i=s.match(d.pattern))&&(n=s.slice(s.lastIndexOf(i[i.length-1]))),n){if(this.state.actions.ArrowLeft=!1,this.state.tag={prefix:n.match(d.pattern)[0],value:n.replace(d.pattern,"")},this.state.tag.baseOffset=o.baseOffset-this.state.tag.value.length,c=this.state.tag.value.match(d.delimiters))return this.state.tag.value=this.state.tag.value.replace(d.delimiters,""),this.state.tag.delimiters=c[0],this.addTags(this.state.tag.value,d.dropdown.clearOnSelect),void this.dropdown.hide();r=this.state.tag.value.length>=d.dropdown.enabled;try{l=(l=this.state.flaggedTags[this.state.tag.baseOffset]).prefix==this.state.tag.prefix&&l.value[0]==this.state.tag.value[0],this.state.flaggedTags[this.state.tag.baseOffset]&&!this.state.tag.value&&delete this.state.flaggedTags[this.state.tag.baseOffset]}catch(e){}(l||a<this.state.mixMode.matchedPatternCount)&&(r=!1)}else this.state.flaggedTags={};this.state.mixMode.matchedPatternCount=a}setTimeout(()=>{this.update({withoutChangeEvent:!0}),this.trigger("input",h({},this.state.tag,{textContent:this.DOM.input.textContent})),this.state.tag&&this.dropdown[r?"show":"hide"](this.state.tag.value)},10)},onInputIE(e){var s=this;setTimeout(function(){s.events.callbacks.onInput.call(s,e)})},observeOriginalInputValue(){this.DOM.originalInput.parentNode||this.destroy(),this.DOM.originalInput.value!=this.DOM.originalInput.tagifyValue&&this.loadOriginalValues()},onClickAnywhere(e){e.target==this.DOM.scope||this.DOM.scope.contains(e.target)||(this.toggleFocusClass(!1),this.state.hasFocus=!1)},onClickScope(e){var s=this.settings,i=e.target.closest("."+s.classNames.tag),a=+new Date-this.state.hasFocus;if(e.target!=this.DOM.scope){if(!e.target.classList.contains(s.classNames.tagX))return i?(this.trigger("click",{tag:i,index:this.getNodeIndex(i),data:v(i),event:e}),void(1!==s.editTags&&1!==s.editTags.clicks||this.events.callbacks.onDoubleClickScope.call(this,e))):void(e.target==this.DOM.input&&("mix"==s.mode&&this.fixFirefoxLastTagNoCaret(),a>500)?this.state.dropdown.visible?this.dropdown.hide():0===s.dropdown.enabled&&"mix"!=s.mode&&this.dropdown.show(this.value.length?"":void 0):"select"!=s.mode||0!==s.dropdown.enabled||this.state.dropdown.visible||this.dropdown.show());this.removeTags(e.target.parentNode)}else this.DOM.input.focus()},onPaste(e){e.preventDefault();var s,i,a=this.settings;if("select"==a.mode&&a.enforceWhitelist||!a.userInput)return!1;a.readonly||(i=(s=e.clipboardData||window.clipboardData).getData("Text"),a.hooks.beforePaste(e,{tagify:this,pastedText:i,clipboardData:s}).then(s=>{void 0===s&&(s=i),s&&(this.injectAtCaret(s,window.getSelection().getRangeAt(0)),"mix"==this.settings.mode?this.events.callbacks.onMixTagsInput.call(this,e):this.settings.pasteAsTags?this.addTags(this.state.inputText+s,!0):this.state.inputText=s)}).catch(e=>e))},onDrop(e){e.preventDefault()},onEditTagInput(e,s){var i=e.closest("."+this.settings.classNames.tag),a=this.getNodeIndex(i),n=v(i),r=this.input.normalize.call(this,e),o={[this.settings.tagTextProp]:r,__tagId:n.__tagId},l=this.validateTag(o);this.editTagChangeDetected(h(n,o))||!0!==e.originalIsValid||(l=!0),i.classList.toggle(this.settings.classNames.tagInvalid,!0!==l),n.__isValid=l,i.title=!0===l?n.title||n.value:l,r.length>=this.settings.dropdown.enabled&&(this.state.editing&&(this.state.editing.value=r),this.dropdown.show(r)),this.trigger("edit:input",{tag:i,index:a,data:h({},this.value[a],{newValue:r}),event:s})},onEditTagPaste(e,s){var i=(s.clipboardData||window.clipboardData).getData("Text");s.preventDefault();var a=y(i);this.setRangeAtStartEnd(!1,a)},onEditTagFocus(e){this.state.editing={scope:e,input:e.querySelector("[contenteditable]")}},onEditTagBlur(e){if(this.state.hasFocus||this.toggleFocusClass(),this.DOM.scope.contains(e)){var s,i,a=this.settings,n=e.closest("."+a.classNames.tag),r=v(n),o=this.input.normalize.call(this,e),l={[a.tagTextProp]:o,__tagId:r.__tagId},c=r.__originalData,d=this.editTagChangeDetected(h(r,l)),u=this.validateTag(l);if(o){if(d){if(s=this.hasMaxTags(),i=h({},c,{[a.tagTextProp]:this.trim(o),__isValid:u}),a.transformTag.call(this,i,c),!0!==(u=(!s||!0===c.__isValid)&&this.validateTag(i))){if(this.trigger("invalid",{data:i,tag:n,message:u}),a.editTags.keepInvalid)return;a.keepInvalidTags?i.__isValid=u:i=c}else a.keepInvalidTags&&(delete i.title,delete i["aria-invalid"],delete i.class);this.onEditTagDone(n,i)}else this.onEditTagDone(n,c)}else this.onEditTagDone(n)}},onEditTagkeydown(e,s){if(!this.state.composing)switch(this.trigger("edit:keydown",{event:e}),e.key){case"Esc":case"Escape":s.parentNode.replaceChild(s.__tagifyTagData.__originalHTML,s),this.state.editing=!1;case"Enter":case"Tab":e.preventDefault(),e.target.blur()}},onDoubleClickScope(e){var s,i,a=e.target.closest("."+this.settings.classNames.tag),n=v(a),r=this.settings;a&&r.userInput&&!1!==n.editable&&(s=a.classList.contains(this.settings.classNames.tagEditing),i=a.hasAttribute("readonly"),"select"==r.mode||r.readonly||s||i||!this.settings.editTags||this.editTag(a),this.toggleFocusClass(!0),this.trigger("dblclick",{tag:a,index:this.getNodeIndex(a),data:v(a)}))},onInputDOMChange(e){e.forEach(e=>{e.addedNodes.forEach(e=>{if("<div><br></div>"==e.outerHTML)e.replaceWith(document.createElement("br"));else if(1==e.nodeType&&e.querySelector(this.settings.classNames.tagSelector)){let s=document.createTextNode("");3==e.childNodes[0].nodeType&&"BR"!=e.previousSibling.nodeName&&(s=document.createTextNode("\n")),e.replaceWith(s,...[...e.childNodes].slice(0,-1)),_(s)}else if(f.call(this,e)){if(3!=e.previousSibling?.nodeType||e.previousSibling.textContent||e.previousSibling.remove(),e.previousSibling&&"BR"==e.previousSibling.nodeName){e.previousSibling.replaceWith("\n​");let s=e.nextSibling,i="";for(;s;)i+=s.textContent,s=s.nextSibling;i.trim()&&_(e.previousSibling)}else e.previousSibling&&!v(e.previousSibling)||e.before("​")}}),e.removedNodes.forEach(e=>{e&&"BR"==e.nodeName&&f.call(this,s)&&(this.removeTags(s),this.fixFirefoxLastTagNoCaret())})});var s=this.DOM.input.lastChild;s&&""==s.nodeValue&&s.remove(),s&&"BR"==s.nodeName||this.DOM.input.appendChild(document.createElement("br"))}}},fixFirefoxLastTagNoCaret(){},setRangeAtStartEnd(e,s){if(s){e="number"==typeof e?e:!!e,s=s.lastChild||s;var i=document.getSelection();if(i.focusNode instanceof Element&&!this.DOM.input.contains(i.focusNode))return!0;try{i.rangeCount>=1&&["Start","End"].forEach(a=>i.getRangeAt(0)["set"+a](s,e||s.length))}catch(e){}}},insertAfterTag(e,s){if(s=s||this.settings.mixMode.insertAfterTag,e&&e.parentNode&&s)return s="string"==typeof s?document.createTextNode(s):s,e.parentNode.insertBefore(s,e.nextSibling),s},editTagChangeDetected(e){var s=e.__originalData;for(var i in s)if(!this.dataProps.includes(i)&&e[i]!=s[i])return!0;return!1},getTagTextNode(e){return e.querySelector(this.settings.classNames.tagTextSelector)},setTagTextNode(e,s){this.getTagTextNode(e).innerHTML=c(s)},editTag(e,s){e=e||this.getLastTag(),s=s||{},this.dropdown.hide();var i=this.settings,a=this.getTagTextNode(e),n=this.getNodeIndex(e),r=v(e),o=this.events.callbacks,l=this,c=!0;if(a){if(!(r instanceof Object&&"editable"in r)||r.editable)return r=v(e,{__originalData:h({},r),__originalHTML:e.cloneNode(!0)}),v(r.__originalHTML,r.__originalData),a.setAttribute("contenteditable",!0),e.classList.add(i.classNames.tagEditing),a.addEventListener("focus",o.onEditTagFocus.bind(this,e)),a.addEventListener("blur",function(){setTimeout(()=>o.onEditTagBlur.call(l,l.getTagTextNode(e)))}),a.addEventListener("input",o.onEditTagInput.bind(this,a)),a.addEventListener("paste",o.onEditTagPaste.bind(this,a)),a.addEventListener("keydown",s=>o.onEditTagkeydown.call(this,s,e)),a.addEventListener("compositionstart",o.onCompositionStart.bind(this)),a.addEventListener("compositionend",o.onCompositionEnd.bind(this)),s.skipValidation||(c=this.editTagToggleValidity(e)),a.originalIsValid=c,this.trigger("edit:start",{tag:e,index:n,data:r,isValid:c}),a.focus(),this.setRangeAtStartEnd(!1,a),this}else console.warn("Cannot find element in Tag template: .",i.classNames.tagTextSelector)},editTagToggleValidity(e,s){var i;if(s=s||v(e))return(i=!("__isValid"in s)||!0===s.__isValid)||this.removeTagsFromValue(e),this.update(),e.classList.toggle(this.settings.classNames.tagNotAllowed,!i),s.__isValid=i,s.__isValid;console.warn("tag has no data: ",e,s)},onEditTagDone(e,s){s=s||{};var i={tag:e=e||this.state.editing.scope,index:this.getNodeIndex(e),previousData:v(e),data:s};this.trigger("edit:beforeUpdate",i,{cloneData:!1}),this.state.editing=!1,delete s.__originalData,delete s.__originalHTML,e&&s[this.settings.tagTextProp]?(e=this.replaceTag(e,s),this.editTagToggleValidity(e,s),this.settings.a11y.focusableTags?e.focus():_(e)):e&&this.removeTags(e),this.trigger("edit:updated",i),this.dropdown.hide(),this.settings.keepInvalidTags&&this.reCheckInvalidTags()},replaceTag(e,s){s&&s.value||(s=e.__tagifyTagData),s.__isValid&&1!=s.__isValid&&h(s,this.getInvalidTagAttrs(s,s.__isValid));var i=this.createTagElem(s);return e.parentNode.replaceChild(i,e),this.updateValueByDOMTags(),i},updateValueByDOMTags(){this.value.length=0,[].forEach.call(this.getTagElms(),e=>{e.classList.contains(this.settings.classNames.tagNotAllowed.split(" ")[0])||this.value.push(v(e))}),this.update()},injectAtCaret(e,s){return(s=s||this.state.selection?.range)||!e?(y(e,s),this.setRangeAtStartEnd(!1,e),this.updateValueByDOMTags(),this.update()):this.appendMixTags(e),this},input:{set(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var i=this.settings.dropdown.closeOnSelect;this.state.inputText=e,s&&(this.DOM.input.innerHTML=c(""+e)),!e&&i&&this.dropdown.hide.bind(this),this.input.autocomplete.suggest.call(this),this.input.validate.call(this)},raw(){return this.DOM.input.textContent},validate(){var e=!this.state.inputText||!0===this.validateTag({value:this.state.inputText});return this.DOM.input.classList.toggle(this.settings.classNames.inputInvalid,!e),e},normalize(e){var s=e||this.DOM.input,i=[];s.childNodes.forEach(e=>3==e.nodeType&&i.push(e.nodeValue)),i=i.join("\n");try{i=i.replace(/(?:\r\n|\r|\n)/g,this.settings.delimiters.source.charAt(0))}catch(e){}return i=i.replace(/\s/g," "),this.trim(i)},autocomplete:{suggest(e){if(this.settings.autoComplete.enabled){"string"==typeof(e=e||{value:""})&&(e={value:e});var s=this.dropdown.getMappedValue(e);if("number"!=typeof s){var i=s.substr(0,this.state.inputText.length).toLowerCase(),a=s.substring(this.state.inputText.length);s&&this.state.inputText&&i==this.state.inputText.toLowerCase()?(this.DOM.input.setAttribute("data-suggest",a),this.state.inputSuggestion=e):(this.DOM.input.removeAttribute("data-suggest"),delete this.state.inputSuggestion)}}},set(e){var s=this.DOM.input.getAttribute("data-suggest"),i=e||(s?this.state.inputText+s:null);return!!i&&("mix"==this.settings.mode?this.replaceTextWithNode(document.createTextNode(this.state.tag.prefix+i)):(this.input.set.call(this,i),this.setRangeAtStartEnd(!1,this.DOM.input)),this.input.autocomplete.suggest.call(this),this.dropdown.hide(),!0)}}},getTagIdx(e){return this.value.findIndex(s=>s.__tagId==(e||{}).__tagId)},getNodeIndex(e){var s=0;if(e)for(;e=e.previousElementSibling;)s++;return s},getTagElms(){for(var e=arguments.length,s=Array(e),i=0;i<e;i++)s[i]=arguments[i];var a="."+[...this.settings.classNames.tag.split(" "),...s].join(".");return[].slice.call(this.DOM.scope.querySelectorAll(a))},getLastTag(){var e=this.DOM.scope.querySelectorAll(`${this.settings.classNames.tagSelector}:not(.${this.settings.classNames.tagHide}):not([readonly])`);return e[e.length-1]},isTagDuplicate(e,s,a){var n=0;if("select"==this.settings.mode)return!1;for(let r of this.value)i(this.trim(""+e),r.value,s)&&a!=r.__tagId&&n++;return n},getTagIndexByValue(e){var s=[],a=this.settings.dropdown.caseSensitive;return this.getTagElms().forEach((n,r)=>{n.__tagifyTagData&&i(this.trim(n.__tagifyTagData.value),e,a)&&s.push(r)}),s},getTagElmByValue(e){var s=this.getTagIndexByValue(e)[0];return this.getTagElms()[s]},flashTag(e){e&&(e.classList.add(this.settings.classNames.tagFlash),setTimeout(()=>{e.classList.remove(this.settings.classNames.tagFlash)},100))},isTagBlacklisted(e){return e=this.trim(e.toLowerCase()),this.settings.blacklist.filter(s=>(""+s).toLowerCase()==e).length},isTagWhitelisted(e){return!!this.getWhitelistItem(e)},getWhitelistItem(e,s,a){s=s||"value";var n,r=this.settings;return(a=a||r.whitelist).some(a=>{if(i("string"==typeof a?a:a[s]||a.value,e,r.dropdown.caseSensitive,r.trim))return n="string"==typeof a?{value:a}:a,!0}),n||"value"!=s||"value"==r.tagTextProp||(n=this.getWhitelistItem(e,r.tagTextProp,a)),n},validateTag(e){var s=this.settings,i="value"in e?"value":s.tagTextProp,a=this.trim(e[i]+"");return(e[i]+"").trim()?"mix"!=s.mode&&s.pattern&&s.pattern instanceof RegExp&&!s.pattern.test(a)?this.TEXTS.pattern:!s.duplicates&&this.isTagDuplicate(a,s.dropdown.caseSensitive,e.__tagId)?this.TEXTS.duplicate:this.isTagBlacklisted(a)||s.enforceWhitelist&&!this.isTagWhitelisted(a)?this.TEXTS.notAllowed:!s.validate||s.validate(e):this.TEXTS.empty},getInvalidTagAttrs(e,s){return{"aria-invalid":!0,class:`${e.class||""} ${this.settings.classNames.tagNotAllowed}`.trim(),title:s}},hasMaxTags(){return this.value.length>=this.settings.maxTags&&this.TEXTS.exceed},setReadonly(e,s){var i=this.settings;document.activeElement.blur(),i[s||"readonly"]=e,this.DOM.scope[(e?"set":"remove")+"Attribute"](s||"readonly",!0),this.settings.userInput=!0,this.setContentEditable(!e)},setContentEditable(e){this.settings.userInput&&(this.DOM.input.contentEditable=e,this.DOM.input.tabIndex=e?0:-1)},setDisabled(e){this.setReadonly(e,"disabled")},normalizeTags(e){var s=this.settings,i=s.whitelist,a=s.delimiters,n=s.mode,r=s.tagTextProp,o=[],l=!!i&&i[0]instanceof Object,c=Array.isArray(e),d=c&&e[0].value,h=e=>(e+"").split(a).filter(e=>e).map(e=>({[r]:this.trim(e),value:this.trim(e)}));if("number"==typeof e&&(e=e.toString()),"string"==typeof e){if(!e.trim())return[];e=h(e)}else c&&(e=[].concat(...e.map(e=>null!=e.value?e:h(e))));return l&&!d&&(e.forEach(e=>{var s=o.map(e=>e.value),i=this.dropdown.filterListItems.call(this,e[r],{exact:!0});this.settings.duplicates||(i=i.filter(e=>!s.includes(e.value)));var a=i.length>1?this.getWhitelistItem(e[r],r,i):i[0];a&&a instanceof Object?o.push(a):"mix"!=n&&(null==e.value&&(e.value=e[r]),o.push(e))}),o.length&&(e=o)),e},parseMixTags(e){var s=this.settings,i=s.mixTagsInterpolator,a=s.duplicates,n=s.transformTag,r=s.enforceWhitelist,o=s.maxTags,l=s.tagTextProp,c=[];e=e.split(i[0]).map((e,s)=>{var d,h,u,p=e.split(i[1]),m=p[0],g=c.length==o;try{if(m==+m)throw Error;h=JSON.parse(m)}catch(e){h=this.normalizeTags(m)[0]||{value:m}}if(n.call(this,h),g||!(p.length>1)||r&&!this.isTagWhitelisted(h.value)||!a&&this.isTagDuplicate(h.value)){if(e)return s?i[0]+e:e}else h[d=h[l]?l:"value"]=this.trim(h[d]),u=this.createTagElem(h),c.push(h),u.classList.add(this.settings.classNames.tagNoAnimation),p[0]=u.outerHTML,this.value.push(h);return p.join("")}).join(""),this.DOM.input.innerHTML=e,this.DOM.input.appendChild(document.createTextNode("")),this.DOM.input.normalize();var d=this.getTagElms();return d.forEach((e,s)=>v(e,c[s])),this.update({withoutChangeEvent:!0}),b(d,this.state.hasFocus),e},replaceTextWithNode(e,s){if(this.state.tag||s){s=s||this.state.tag.prefix+this.state.tag.value;var i,a,n=this.state.selection||window.getSelection(),r=n.anchorNode,o=this.state.tag.delimiters?this.state.tag.delimiters.length:0;return r.splitText(n.anchorOffset-o),-1==(i=r.nodeValue.lastIndexOf(s))||(a=r.splitText(i),e&&r.parentNode.replaceChild(e,a),!0)}},selectTag(e,s){var i=this.settings;if(!i.enforceWhitelist||this.isTagWhitelisted(s.value)){this.input.set.call(this,s[i.tagTextProp]||s.value,!0),this.state.actions.selectOption&&setTimeout(()=>this.setRangeAtStartEnd(!1,this.DOM.input));var a=this.getLastTag();return a?this.replaceTag(a,s):this.appendTag(e),this.value[0]=s,this.update(),this.trigger("add",{tag:e,data:s}),[e]}},addEmptyTag(e){var s=h({value:""},e||{}),i=this.createTagElem(s);v(i,s),this.appendTag(i),this.editTag(i,{skipValidation:!0})},addTags(e,s,i){var a=[],n=this.settings,r=[],o=document.createDocumentFragment();if(i=i||n.skipInvalid,!e||0==e.length)return a;switch(e=this.normalizeTags(e),n.mode){case"mix":return this.addMixTags(e);case"select":s=!1,this.removeAllTags()}return this.DOM.input.removeAttribute("style"),e.forEach(e=>{var s,l={},c=Object.assign({},e,{value:e.value+""});if(e=Object.assign({},c),n.transformTag.call(this,e),e.__isValid=this.hasMaxTags()||this.validateTag(e),!0!==e.__isValid){if(i)return;if(h(l,this.getInvalidTagAttrs(e,e.__isValid),{__preInvalidData:c}),e.__isValid==this.TEXTS.duplicate&&this.flashTag(this.getTagElmByValue(e.value)),!n.createInvalidTags)return void r.push(e.value)}if("readonly"in e&&(e.readonly?l["aria-readonly"]=!0:delete e.readonly),s=this.createTagElem(e,l),a.push(s),"select"==n.mode)return this.selectTag(s,e);o.appendChild(s),e.__isValid&&!0===e.__isValid?(this.value.push(e),this.trigger("add",{tag:s,index:this.value.length-1,data:e})):(this.trigger("invalid",{data:e,index:this.value.length,tag:s,message:e.__isValid}),n.keepInvalidTags||setTimeout(()=>this.removeTags(s,!0),1e3)),this.dropdown.position()}),this.appendTag(o),this.update(),e.length&&s&&(this.input.set.call(this,n.createInvalidTags?"":r.join(n._delimiters)),this.setRangeAtStartEnd(!1,this.DOM.input)),n.dropdown.enabled&&this.dropdown.refilter(),a},addMixTags(e){if((e=this.normalizeTags(e))[0].prefix||this.state.tag)return this.prefixedTextToTag(e[0]);var s=document.createDocumentFragment();return e.forEach(e=>{var i=this.createTagElem(e);s.appendChild(i)}),this.appendMixTags(s),s},appendMixTags(e){var s=!!this.state.selection;s?this.injectAtCaret(e):(this.DOM.input.focus(),(s=this.setStateSelection()).range.setStart(this.DOM.input,s.range.endOffset),s.range.setEnd(this.DOM.input,s.range.endOffset),this.DOM.input.appendChild(e),this.updateValueByDOMTags(),this.update())},prefixedTextToTag(e){var s,i=this.settings,a=this.state.tag.delimiters;return i.transformTag.call(this,e),e.prefix=e.prefix||this.state.tag?this.state.tag.prefix:(i.pattern.source||i.pattern)[0],s=this.createTagElem(e),this.replaceTextWithNode(s)||this.DOM.input.appendChild(s),setTimeout(()=>s.classList.add(this.settings.classNames.tagNoAnimation),300),this.value.push(e),this.update(),a||setTimeout(_,0,this.insertAfterTag(s)||s),this.state.tag=null,this.trigger("add",h({},{tag:s},{data:e})),s},appendTag(e){var s=this.DOM,i=s.input;s.scope.insertBefore(e,i)},createTagElem(e,i){e.__tagId=g();var a,n=h({},e,s({value:c(e.value+"")},i));return function(e){for(var s,i=document.createNodeIterator(e,NodeFilter.SHOW_TEXT,null,!1);s=i.nextNode();)s.textContent.trim()||s.parentNode.removeChild(s)}(a=this.parseTemplate("tag",[n,this])),v(a,e),a},reCheckInvalidTags(){var e=this.settings;this.getTagElms(e.classNames.tagNotAllowed).forEach((s,i)=>{var a=v(s),n=this.hasMaxTags(),r=this.validateTag(a),o=!0===r&&!n;if("select"==e.mode&&this.toggleScopeValidation(r),o)return a=a.__preInvalidData?a.__preInvalidData:{value:a.value},this.replaceTag(s,a);s.title=n||r})},removeTags(e,s,i){var a,n=this.settings;if(a=(e=e&&e instanceof HTMLElement?[e]:e instanceof Array?e:e?[e]:[this.getLastTag()]).reduce((e,s)=>{s&&"string"==typeof s&&(s=this.getTagElmByValue(s));var i=v(s);return s&&i&&!i.readonly&&e.push({node:s,idx:this.getTagIdx(i),data:v(s,{__removed:!0})}),e},[]),i="number"==typeof i?i:this.CSSVars.tagHideTransition,"select"==n.mode&&(i=0,this.input.set.call(this)),1==a.length&&"select"!=n.mode&&a[0].node.classList.contains(n.classNames.tagNotAllowed)&&(s=!0),a.length)return n.hooks.beforeRemoveTag(a,{tagify:this}).then(()=>{function e(e){e.node.parentNode&&(e.node.parentNode.removeChild(e.node),s?n.keepInvalidTags&&this.trigger("remove",{tag:e.node,index:e.idx}):(this.trigger("remove",{tag:e.node,index:e.idx,data:e.data}),this.dropdown.refilter(),this.dropdown.position(),this.DOM.input.normalize(),n.keepInvalidTags&&this.reCheckInvalidTags()))}i&&i>10&&1==a.length?(function(s){s.node.style.width=parseFloat(window.getComputedStyle(s.node).width)+"px",document.body.clientTop,s.node.classList.add(n.classNames.tagHide),setTimeout(e.bind(this),i,s)}).call(this,a[0]):a.forEach(e.bind(this)),s||(this.removeTagsFromValue(a.map(e=>e.node)),this.update(),"select"==n.mode&&this.setContentEditable(!0))}).catch(e=>{})},removeTagsFromDOM(){[].slice.call(this.getTagElms()).forEach(e=>e.parentNode.removeChild(e))},removeTagsFromValue(e){(e=Array.isArray(e)?e:[e]).forEach(e=>{var s=v(e),i=this.getTagIdx(s);i>-1&&this.value.splice(i,1)})},removeAllTags(e){e=e||{},this.value=[],"mix"==this.settings.mode?this.DOM.input.innerHTML="":this.removeTagsFromDOM(),this.dropdown.refilter(),this.dropdown.position(),this.state.dropdown.visible&&setTimeout(()=>{this.DOM.input.focus()}),"select"==this.settings.mode&&(this.input.set.call(this),this.setContentEditable(!0)),this.update(e)},postUpdate(){this.state.blockChangeEvent=!1;var e=this.settings,s=e.classNames,i="mix"==e.mode?e.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value.trim():this.value.length+this.input.raw.call(this).length;this.toggleClass(s.hasMaxTags,this.value.length>=e.maxTags),this.toggleClass(s.hasNoTags,!this.value.length),this.toggleClass(s.empty,!i),"select"==e.mode&&this.toggleScopeValidation(this.value?.[0]?.__isValid)},setOriginalInputValue(e){var s=this.DOM.originalInput;this.settings.mixMode.integrated||(s.value=e,s.tagifyValue=s.value,this.setPersistedData(e,"value"))},update(e){clearTimeout(this.debouncedUpdateTimeout),this.debouncedUpdateTimeout=setTimeout((function(){var s=this.getInputValue();this.setOriginalInputValue(s),this.settings.onChangeAfterBlur&&(e||{}).withoutChangeEvent||this.state.blockChangeEvent||this.triggerChangeEvent(),this.postUpdate()}).bind(this),100)},getInputValue(){var e=this.getCleanValue();return"mix"==this.settings.mode?this.getMixedTagsAsString(e):e.length?this.settings.originalInputValueFormat?this.settings.originalInputValueFormat(e):JSON.stringify(e):""},getCleanValue(e){return a(e||this.value,this.dataProps)},getMixedTagsAsString(){var e="",s=this,i=this.settings,a=i.originalInputValueFormat||JSON.stringify,r=i.mixTagsInterpolator;return function i(o){o.childNodes.forEach(o=>{if(1==o.nodeType){let l=v(o);if("BR"==o.tagName&&(e+="\r\n"),l&&f.call(s,o)){if(l.__removed)return;e+=r[0]+a(n(l,s.dataProps))+r[1]}else o.getAttribute("style")||["B","I","U"].includes(o.tagName)?e+=o.textContent:"DIV"!=o.tagName&&"P"!=o.tagName||(e+="\r\n",i(o))}else e+=o.textContent})}(this.DOM.input),e}},O.prototype.removeTag=O.prototype.removeTags,O}();class f{_name=null;_description=null;boons=0;banes=0;modifier=0;divide=0;percent=0;static GRAY="--tag-bg:#a1a1a1;--tag-text-color:#2b2a2a;--tag-hover:#bababa;--tag-remove-bg:#a1a1a1;--tag-remove-btn-color:#2b2a2a";static RED="--tag-bg:#d19d9d;--tag-text-color:#530d0d;--tag-hover:#e1b4b4;--tag-remove-bg:#d19d9d;--tag-remove-btn-color:#530d0d";static GREEN="--tag-bg:#9dd1ab;--tag-text-color:#224939;--tag-hover:#b5e0c1;--tag-remove-bg:#9dd1ab;--tag-remove-btn-color:#224939";constructor({name:e=null,description:s=null,boons:i=0,banes:a=0,modifier:n=0,divide:r=0,percent:o=0}){this._name=e,this._description=s,this.boons=parseInt(i)||0,this.banes=parseInt(a)||0,this.modifier=parseInt(n)||0,this.divide=parseInt(r)||0,this.percent=parseInt(o)||0}get name(){return this._name?`${this._name} ${this.mod_str()}`:this.mod_str()}get description(){return this._description||this._name}mod_str(){let e="⊕".repeat(this.boons)+"⊖".repeat(this.banes),s=this.modifier>=0?`+${this.modifier}`:`${this.modifier}`;return e?this.modifier?e+s:e:s}tag(){return{value:this.name,title:this.description,style:f.color(this.name)}}json(){return{boons:this.boons,banes:this.banes,modifier:this.modifier,divide:this.divide,percent:this.percent,name:this.name,description:this.description}}static parse(e){let s=[];try{return e.forEach(e=>{let i=new URLSearchParams(e);s.push(new f({name:i.get("name"),description:i.get("description"),boons:i.get("boons"),banes:i.get("banes"),modifier:i.get("modifier"),divide:i.get("divide"),percent:i.get("percent")}))}),s}catch(s){return console.error(`Error parsing modifiers object: ${e}`),[]}}static color(e){let s=e.includes("+")||e.includes("⊕"),i=e.includes("-")||e.includes("⊖");return s&&i?f.GRAY:s?f.GREEN:i?f.RED:f.GRAY}static total_modifiers(e){let s=0,i=0,a=0,n=0,r=0,o=[];return e.forEach(e=>{s+=e.boons||0,i+=e.banes||0,a+=e.modifier||0,n+=e.divide||0,r+=e.percent||0,e.name&&o.push(e.name)}),{boons:s,banes:i,modifier:a,divide:n,percent:r,tags:o}}static list_from_string(e){let s=null;try{e&&(s=JSON.parse(e))}catch(e){console.error("Error parsing list from tagify")}return s?(Array.isArray(s)||(s=[s]),s.map(e=>f.from_tag(e))):[]}static from_tag(e){let s="string"==typeof e||e instanceof String?e:e.value;if(!s)return{};let i=s.split(" "),a=i.pop(),n=i.join(" "),r=parseInt(a.replace(/^\D+/,""))||null,o=a.replace(/[0-9]/g,"");null!==r&&"-"===o.at(-1)&&(r*=-1),null!==r&&(o=o.slice(0,-1));let l=(o.match(/[+⊕]/g)||[]).length,c=(o.match(/[-⊖]/g)||[]).length;return new f({name:n.replace(/[⊕⊖]/g,""),boons:l,banes:c,modifier:r||0})}}Hooks.once("init",async()=>{Handlebars.registerHelper("skillSelect",(e,s)=>{let i=RegExp.escape(Handlebars.escapeExpression(e)),a=RegExp(` value=["']${i}["']`);return s.fn(void 0).replace(a,"$& selected")})});const y={"":"--",strength:"Strength",dexterity:"Dexterity",speed:"Speed",endurance:"Endurance",intelligence:"Intelligence",perception:"Perception",charisma:"Charisma",determination:"Determination"},v={"":"--",defense:"Defense",willpower:"Willpower"},_={"":"--",defense:"Defense",crew:"Crew"};class b{_actor=null;_label=null;target=null;target_score=null;critical=!1;evaluated=!1;margin=null;pairs=null;results=null;skill_value=0;stat_value=0;success=!1;randomizer=null;total=null;use_pair=!1;constructor(e){Object.assign(this,e),this.validate()}validate(){if(!((this.sceneId&&this.tokenId||this.actorId||this.actor)&&this.actor&&this.actor.system&&(this.actor.system?.stats&&this.actor.system?.stats[this.stat]||this.actor.system?.scores&&this.actor.system?.scores[this.stat]||!this.stat)))throw`Test missing required data: scene=${this.sceneId}, token=${this.tokenId}, actor=${this.actorId}, stat=${this.stat}`;if(this.tn&&!isNaN(this.tn)&&(this.tn=Number(this.tn)),this.boons&&!isNaN(this.boons)?this.boons=Number(this.boons):this.boons=0,this.banes&&!isNaN(this.banes)?this.banes=Number(this.banes):this.banes=0,this.modifier&&!isNaN(this.modifier)?this.modifier=Number(this.modifier):this.modifier=0,this.effects){if(Array.isArray(this.effects)&&this.effects.every(e=>e instanceof l))return;let e=null;Array.isArray(e="string"==typeof this.effects?JSON.parse(this.effects):this.effects)||(e=[e]);for(let s=0;s<e.length;s++)e[s]=new l(e[s],this);this.effects=e}}set actor(e){this._actor=e}get actor(){if(this._actor)return this._actor;if(this.sceneId&&this.tokenId){let e=game.scenes.get(sceneId);if(!e)return null;let s=e.items.get(tokenId);if(!s)return null;let i=new Token(s);return this._actor=i.actor,this._actor}return this._actor=game.actors.get(this.actorId)||null,this._actor}get label(){var e,i,a;return this._label||(this._label=(e=this.stat,i=this.skill,a=this.tn,(e?function(e){if("strength"===e.toLowerCase())return"Str";if("dexterity"===e.toLowerCase())return"Dex";if("speed"===e.toLowerCase())return"Spd";if("endurance"===e.toLowerCase())return"End";if("intelligence"===e.toLowerCase())return"Int";if("perception"===e.toLowerCase())return"Per";if("charisma"===e.toLowerCase())return"Chr";else if("determination"===e.toLowerCase())return"Det";else return s(e)}(e):"")+(i?`/${i}`:"")+(a?isNaN(a)?` vs. ${a}`:`-${a}`:""))),this._label}roll_syntax(){let e=this.boons-this.banes;return 0===e?"1d10":e>0?`${e+1}d10kh1`:`${-1*e+1}d10kl1`}make_pairs(){if(this.banes>=this.boons)return[null,!1];let e=[],s=0;for(let i of this.results.dice[0].results)e.includes(i.result)&&i.result>s&&(s=i.result),e.push(i.result);let i=2*s>this.results.total;if(2*s>this.results.total){this.results._total=2*s;let e=0;for(let i of this.results.dice[0].results)i.result===s&&e<2?(i.discarded=!1,e++):i.discarded=!0}return[s,i]}lookup_skill(){let e=this.skill.match(/\(([^\)]+)\)/);e&&(e=e[e.length-1]);let s=e?this.skill.split(" ")[0]:this.skill,i=[];return(e?(e=e.replace(/[()]/g,""),i=this.actor.items.filter(i=>"skill"===i.type&&i.name===s&&i.system.specialization===e)):i=this.actor.items.filter(e=>"skill"===e.type&&e.name===s),i.length||(i=this.actor.items.filter(e=>"skill"===e.type&&e.name===this.skill)),i.length)?Number(i[0].system.rank):0}calc_total(){let e=this.stat?this.stat in(this.actor.system?.stats||[])?this.actor.system?.stats[this.stat].value:this.actor.system?.scores[this.stat].value:0,s=!!this.skill,i=s&&"Unskilled"!==this.skill?this.lookup_skill():0;s&&!i&&(e=Math.floor(e/2));let a=this.pairs&&2*this.pairs>this.results.total?2*this.pairs:this.results.total;return[a+e+i+this.modifier,a,e,i]}lookup_tn(){if("string"!=typeof this.tn)return[this.tn,null,null];let e="defense"===this.tn.toLowerCase(),s="willpower"===this.tn.toLowerCase();if(!e&&!s)return!1;let i=game?.user?.targets?.values()?.next()?.value?.actor,a=i?.system?.scores;return a?[e?a.defense.tn:a.willpower.tn,i,this.tn]:[null,null,null]}double_ones(){let e=0;for(let s of this.results.dice[0].results)1===s.result&&e++;return e>=2}calc_margin(){if(!this.tn)return[null,null,null];let e=Math.abs(this.total-this.tn),s=this.total>=this.tn,i=e>=this.tn||this.total<this.tn/2;return this.banes>this.boons&&this.double_ones()&&(s&&(s=!1,e=0),i=!0),[s,i,e]}async evaluate(){let e=new Roll(this.roll_syntax());return this.results=await e.evaluate(),[this.pairs,this.use_pair]=this.make_pairs(),[this.total,this.randomizer,this.stat_value,this.skill_value]=this.calc_total(),[this.tn,this.target,this.target_score]=this.lookup_tn(),[this.success,this.critical,this.margin]=this.calc_margin(),this.evaluated=!0,this}async apply_effects(e){this.effects||(this.effects=[]);let s=e?.properties||this.properties||[];if(!this.effects_evaluated){if(r.has_property(s,"Auto")){let e=this.basic_attack_damage()||{value:0,damage_type:"sm"};for(let i=this.margin-5;i>0;i-=5)this.effects.push(new l({type:"damage",value:e.value,damage_type:e.damage_type,margin:i,when:"success",target:"target",properties:s},this));this.effects.push(new l({type:"message",key:"Ammo",value:`Automatic fire consumes ${r.property_value(s,"Auto")} shots.`},this))}r.has_property(s,"Stun")&&this.effects.push(new l({type:"consequence",name:"Stunned",when:"success",target:"target"},this));let e=["defense","damage","consequence","message"];this.effects.sort((s,i)=>e.indexOf(s.type)>e.indexOf(i.type)?1:e.indexOf(s.type)<e.indexOf(i.type)?-1:e.indexOf(s.type)===e.indexOf(i.type)?0:void 0),this.effects_evaluated=!0}let i=this.success?"success":this.tn?"failure":"always";for(let s of this.effects)s.apply(i,e)}basic_attack_damage(){let e=this.effects.filter(e=>"damage"===e.type);return e.length?e[0]:null}flavor(){let e=this.target?`<div><strong>Target:</strong> ${this.target.name} (${s(this.target_score)} ${this.tn})</div>`:"",i=(this.critical?"Critical ":"")+(this.target_score?this.success?"Hit!":"Miss!":this.success?"Success!":"Failure!"),a=(this.critical?"critical ":"")+(this.success?"success":"failure"),n=this.tn?`<div><strong>Result:</strong> <span class="${a}">${i}</span> Margin ${this.margin}</div>`:"",r="";if(this.effects)for(let e of this.effects)r+=e.message;let o="";return this.stat&&(o+=`<span class="tag">${s(this.stat)} +${this.stat_value}</span>`),this.skill&&"Unskilled"!==this.skill&&(o+=`<span class="tag">${this.skill} +${this.skill_value}</span>`),this.skill&&0===this.skill_value&&(o+='<span class="tag">Unskilled</span>'),this.tags&&this.tags.length&&this.tags.forEach(e=>o+=`<span class="tag">${e}</span>`),this.use_pair&&(o+='<span class="tag">Pairs!</span>'),this.use_luck&&(o+='<span class="tag">Luck</span>'),this.edited&&(o+='<span class="tag">Edited</span>'),`<h4 class="action">${this.label}</h4>
                ${e} 
                ${n} 
                ${r}
                <hr />
                <div class="tags">${o}</div>`}dice_html(){let e='<ol class="dice-rolls">';for(let s of this.results.dice[0].results){let i=s.discarded?"discarded":"";e+=`<li class="roll die d10 ${i}">${s.result}</li>`}return e+"</ol>"}content(){let e=this.stat_value?`+ <span title="Stat">${this.stat_value}</span>`:"",s=this.skill_value?`+ <span title="Skill">${this.skill_value}</span>`:"",i=this.modifier?`+ <span title="Modifier">${this.modifier}</span>`:"",a=JSON.stringify(b.to_json(this));return`
            <div class="dice-roll">
                <div class="dice-result">
                    <div class="dice-formula">
                        ${this.results.formula} ${s} ${e} ${i}
                    </div>
                    <div class="dice-tooltip">
                        <section class="tooltip-part">
                            <div class="dice">
                                <header class="part-header flexrow">
                                    <span class="part-formula">${this.results.formula}</span>
                                    <span class="part-total">${this.results.total}</span>
                                </header>
                                ${this.dice_html()}
                            </div>
                        </section>
                    </div>
                    <h4 class="dice-total">${this.total}</h4>
                </div>
            </div>
            <input type="hidden" class="test-json" value='${a}' />`}async to_chat({whisper:e=!1,rolls:s=null}){s&&(Array.isArray(s)||(s=[s]),s=s.map(e=>JSON.stringify(e.toJSON()))),await ChatMessage.create({content:this.content(),flavor:this.flavor(),rolls:s||(e?[]:[this.results]),speaker:ChatMessage.getSpeaker({actor:this.actor}),whisper:e?game.users.filter(e=>e.isGM||e.character?.id===this.actor?.id).map(e=>e.id):[]})}static to_json(e){let s={};for(let[i,a]of Object.entries(e))if("string"==typeof a||"number"==typeof a||"boolean"==typeof a||null===a)s[i]=a;else if("_actor"===i||"target"===i)s[i]={uuid:a.uuid};else if("effects"===i){let a=[];for(let s of e.effects)a.push(l.to_json(s));s[i]=a}else"results"===i&&(s[i]={_evaluated:a._evaluated,_formula:a._formula,_total:a._total,_terms:a.terms[0].results});return s}static from_json(e){let s={};for(let[a,n]of Object.entries(e))"string"==typeof n||"number"==typeof n||"boolean"==typeof n||null===n?s[a]=e[a]:"_actor"===a||"target"===a?n instanceof game.sagamachine.SagaMachineActor?s[a]=n:s[a]=i(n):"effects"===a?s[a]=n:"results"===a&&(s[a]=new Roll(n._formula),s[a]._evaluated=n._evaluated,s[a]._formula=n._formula,s[a]._total=n._total,s[a].terms=[new foundry.dice.terms.Die({faces:10})],s[a].terms[0].results=n._terms);return new b(s)}}async function w(s,a=null){let n=i(s),r="vehicle"===n.type?_:v;new Dialog({title:"Make Test",content:await renderTemplate("systems/saga-machine/templates/apps/test-dialog.html",{actor:{...n.sheet.getData().data},STAT_OPTIONS:y,SCORE_OPTIONS:r,...s}),render:i=>{let a=n.modifiers(s),r=i.find("input[name=modifiers]");if(!r)return;let o=new(e(g))(r[0],{duplicates:!0,transformTag:e=>{e.style=f.color(e.value),isNaN(parseInt(e.value.split(" ").at(-1)))&&(e.value=e.value.replaceAll("+","⊕").replaceAll("-","⊖"))}}),l=foundry.utils.deepClone(o.value),c=a.map(e=>e.tag());o.addTags(c);let d=i.find("input[name=properties]");new(e(g))(d[0],{duplicates:!0,transformTag:e=>{e.style=f.GRAY}}),i.find("select[name=stat], select[name=score], select[name=skill], input[name=tn], input[name=properties]").on("change",e=>{let a=JSON.parse(JSON.stringify(s));a.stat=i.find("select[name=stat]").val(),a.score=i.find("select[name=score]").val(),a.skill=i.find("select[name=skill]").val(),a.tn=i.find("input[name=tn]").val();let r=i.find("input[name=properties]").val()||"[]";a.properties=JSON.parse(r).map(e=>e.value).join(",");let c=n.modifiers(a);o.removeAllTags(),o.addTags(l),o.addTags(c.map(e=>e.tag()))})},buttons:{roll:{label:"Make Test",callback:async e=>{e.find("select[name=stat] > option:selected").trigger("focus"),setTimeout(async()=>{let i=e.find("select[name=stat] > option:selected").val(),r=e.find("select[name=score] > option:selected").val(),o=e.find("select[name=skill] > option:selected").val(),{boons:l,banes:c,modifier:d,tags:h}=f.total_modifiers(f.list_from_string(e.find("input[name=modifiers]").val())),u=new b({actor:n,stat:i||r,skill:o||null,boons:l||0,banes:c||0,modifier:d||0,tags:h,tn:e.find("input[name=tn]").val()||null,effects:e.find("input[name=effects]").val()||null});await u.evaluate(),await u.apply_effects(s);let p=!!s.whisper;await u.to_chat({whisper:p}),a&&await a(u)},200)},icon:'<i class="fas fa-check"></i>'}},default:"roll"}).render(!0,{width:450})}const T=()=>{let e=[];return["Bleeding","Bolstered","Dazed","Defeated","Desire","Disabled","Dying","Fatigue","Fear","Fixation","Grave Wound","Hidden","Hindered","Prone","Stunned","Wound"].forEach(s=>e.push({icon:`systems/saga-machine/images/consequences/${s.slugify()}.svg`,statuses:[s.slugify()],name:s,id:s.slugify(),flags:{core:{overlay:["Defeated"].includes(s)},system:{subject_prompt:["Bleeding","Desire","Fear","Fixation"].includes(s),value_prompt:["Fatigue","Grave Wound","Wound"].includes(s),remove_others:["Desire","Fixation"].includes(s),no_consequence:["Defeated","Unconscious"].includes(s)}}})),e};async function k({name:e,actor:s,skip_actor:i=!1,skip_global:a=!1,skip_new:n=!1}){let r=null;return i||(r=s?.items.filter(s=>s.name===e&&"consequence"===s.type).values().next()?.value),a||r||(r=game.items.filter(s=>s.name===e&&"consequence"===s.type).values().next()?.value),n||r||(r=await Item.create({name:e.capitalize(),type:"consequence",system:{rank:1}})),r}async function x(e){let s=new Set(e.items.filter(e=>"consequence"===e.type&&e.system.rank>0&&game.sagamachine.standard_consequences.includes(e.name)).map(e=>e.name.slugify())),i=e.statuses,a=s.difference(i),n=i.difference(s);n.delete("defeated"),n.delete("unconscious");let r=[];CONFIG.statusEffects.forEach(e=>{a.has(e.id)&&r.push(foundry.utils.deepClone(e))}),r.length&&await e.createEmbeddedDocuments("ActiveEffect",r),n.size&&await e.deleteEmbeddedDocuments("ActiveEffect",e.effects.filter(e=>n.has(e.name.slugify())).map(e=>e.id));let o=new Set(e.effects.map(e=>e.name));if(o.size!==e.effects.size)for(let s of o){if(!game.sagamachine.standard_consequences.includes(s))return;let i=e.effects.filter(e=>e.name===s);i.length>1&&(i.shift(),await e.deleteEmbeddedDocuments("ActiveEffect",i.map(e=>e.id)))}}async function D(e,s=!1){for(let s of e.parent.effects.filter(s=>s.origin===e.uuid))s.delete();if(s)return;let i=[];for(let s of e.effects)i.push(s.clone({parent:e.parent,origin:e.uuid}));e.parent.createEmbeddedDocuments("ActiveEffect",i)}async function O(e){let s=await fromUuid(e.origin);if(!s)return!0;for(let i of e.changes)i.value=function(e,s){let i=e=>Function(`'use strict'; return (${e})`)(),a=new URLSearchParams(e.replaceAll("+","%2b"));for(let e of["boons","banes","modifier","divide","percent"])if(a.has(e)){var n;a.set(e,i((n=(n=a.get(e)).replaceAll("@rank",s.system.rank),s.parent&&(n=n.replaceAll("@str",s.parent.system.stats.strength.value).replaceAll("@dex",s.parent.system.stats.dexterity.value).replaceAll("@spd",s.parent.system.stats.speed.value).replaceAll("@end",s.parent.system.stats.endurance.value).replaceAll("@int",s.parent.system.stats.intelligence.value).replaceAll("@per",s.parent.system.stats.perception.value).replaceAll("@chr",s.parent.system.stats.charisma.value).replaceAll("@det",s.parent.system.stats.determination.value)),n)))}return a.toString()}(i.value,s);return await e.updateSource({changes:e.changes}),!0}async function N(e){let s=e.target,i=e.statuses.first();if(e?.flags?.system?.no_consequence)return;let a=s.items.filter(e=>e.name.slugify()===i&&"consequence"===e.type).values().next()?.value;a||((a=game.items.filter(s=>s.name===e.name&&"consequence"===s.type).values().next()?.value)||(a=await Item.create({name:i.capitalize(),type:"consequence",system:{rank:1}})),e?.flags?.system?.subject_prompt&&new Dialog({title:`Specify Subject of ${a.name}`,content:`
                    <form>
                        <div class="form-group">
                            <label for="subject">Subject</label>
                            <input type="text" name="subject" value="" autofocus>
                        </div>
                    </form>`,buttons:{Confirm:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async i=>{let n=i.find("[name=subject]").val().trim();a.update({"system.specialization":n,"system.rank":1}),a.system.specialization=n,e?.flags?.system?.remove_others&&s.items.filter(e=>e.name===a.name&&"consequence"===e.type&&e.system.specialization!==n).forEach(e=>e.delete())}}},default:"Confirm"}).render(!0),e?.flags?.system?.value_prompt&&new Dialog({title:`Specify Descriptor and Value of ${a.name}`,content:`
                    <form>
                        <div class="grid grid-2col">
                            <label for="subject">Descriptor (optional)</label>
                            <input type="text" name="subject" value="" autofocus>
                            <label for="value">Value</label>
                            <input type="number" name="value" value="1">
                        </div>
                    </form>`,buttons:{Confirm:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async e=>{let s=e.find("[name=subject]").val().trim(),i=parseInt(e.find("[name=value]").val())||1;a.update({"system.specialization":s,"system.rank":i})}}},default:"Confirm"}).render(!0),[a]=await s.createEmbeddedDocuments("Item",[a]))}async function S(e){let s=e.target,i=s.items.filter(s=>s.name===e.name&&"consequence"===s.type);i.length&&await s.deleteEmbeddedDocuments("Item",i.map(e=>e.id))}class C extends Actor{async prepareDerivedData(){super.prepareDerivedData(),"character"===this.type&&await I.calculate_scores(this),"stash"===this.type&&await E.calculate_scores(this),"vehicle"===this.type&&await M.calculate_scores(this)}getRollData(){let e=super.getRollData();if(e.stats){for(let s of Object.keys(e.stats))e[s]=e.stats[s].value;for(let s of Object.keys(e.scores))e[s]=e.scores[s].value}return e}getInitiativeRoll(e=null){return new Roll(e||(this.is_npc()?h.NPC_TURN:this.system.fast_turn?h.FAST_TURN:h.SLOW_TURN))}calculate_score(e,s,i={}){let a=Array.isArray(s)?function(e){let s=Math.floor(e.length/2),i=[...e].sort((e,s)=>e-s);return e.length%2!=0?i[s]:(i[s-1]+i[s])/2}(s):s,n=this.total_modifiers({base_score:e,...i}),r=1+n.percent/100;return Math.floor((a+n.modifier)*r/(n.divide||1))}armor_properties(){let e=this.items.filter(e=>"item"===e.type&&"Armor"===e.system.group&&e.system.equipped),s={Armor:0,Bulky:0,Powered:0};for(let i of e)i.system.armor>s.Armor&&(s.Armor=i.system.armor),i.system.bulky>s.Bulky&&(s.Bulky=i.system.bulky),i.system.powered>s.Powered&&(s.Powered=i.system.powered),i.system.properties.includes("Sealed")&&(s.Sealed=!0);return s}armor_value(){if(this.system.scores.armor.properties.Armor)return this.system.scores.armor.properties.Armor;let e=this.items.filter(e=>"item"===e.type&&"Armors"===e.system.group&&e.system.equipped),s=0;for(let i of e){let e=i.system.armor;e>s&&(s=e)}return s}encumbrance_total(){return this.items.filter(e=>"item"===e.type).reduce((e,s)=>s.system.encumbrance+e,0)}wound_total(){return this.items.filter(e=>"consequence"===e.type&&("wound"===e.name.toLowerCase()||"grave wound"===e.name.toLowerCase()||"fatigue"===e.name.toLowerCase())).map(e=>e.system.rank).reduce((e,s)=>e+s,0)}has_trait(e,s=null){let i=this.items.filter(s=>"trait"===s.type&&s.name.toLowerCase()===e.toLowerCase());if(!s)return!!i.length;let a=!1;for(let e of i)for(let i of e.system.specialization&&e.system.specialization.split(","))i.trim().toLowerCase()===s&&(a=!0);return a}has_immunity(e){return this.has_trait("Immunity",e)}has_vulnerability(e){return this.has_trait("Vulnerability",e)}has_resistance(e){return this.has_trait("Resistance",e)}dying_tn(){return Math.abs(Math.min(this.system.scores.health.max-this.system.scores.health.value,0))}async apply_damage(e,s,i,a){i="true"===i||!0===i;let n=(a=Number(a))===l.IGNORES_ALL_ARMOR?Number(e):Number(e)-Math.max(this.system.scores.armor.value-Math.max(a,0),0);if(this.has_immunity(s)&&(ChatMessage.create({content:"The character has immunity. Ignoring damage.",whisper:[game.user.id]}),n=0),this.has_vulnerability(s)&&(ChatMessage.create({content:"The character has vulnerability. Doubling damage.",whisper:[game.user.id]}),n*=2),this.has_resistance(s)&&(ChatMessage.create({content:"The character has resistance. Halving damage.",whisper:[game.user.id]}),n=Math.floor(n/2)),n<=0)return;this.system.scores.health.value+n>=this.system.scores.health.max&&(i=!0,"fat"===s?ChatMessage.create({content:`Wound Total exceeds Health. ${this.name} must succeed at an <strong>End-${this.system.scores.health.fatigue+n}</strong> test or fall unconscious for [[1d10]] hours.`}):ChatMessage.create({content:`Wound Total exceeds Health. ${this.name} takes a Grave Wound.`}));let r=Math.floor(this.system.scores.health.value/this.system.scores.health.max),o=Math.max(Math.floor((this.system.scores.health.value+n)/this.system.scores.health.max)-r,this.system.scores.health.value>this.system.scores.health.max&&"fat"!==s?1:0);if("fat"===s&&0===r&&o--,o>0){let e=!1,s=this?.items.filter(e=>"Dying"===e.name&&"consequence"===e.type).values().next()?.value;s?e=!0:(s=await k({name:"Dying",actor:this,skip_actor:!0}),[s]=await this.createEmbeddedDocuments("Item",[s]));let i=e?s.system.rank+o:o;if(await s.update({"system.rank":i}),i>=3&&!this.statuses.has("defeated")){let e=null;if(CONFIG.statusEffects.forEach(s=>{"defeated"===s.id&&(e=s)}),e){let s=foundry.utils.deepClone(e);ActiveEffect.create(s,{parent:this}),ChatMessage.create({content:`Dying consequences exceed 3 or more. ${this.name} is dead.`})}}}let c=null;c="fat"===s?"Fatigue":i?"Grave Wound":"Wound";let h=game.items.filter(e=>e.name===c&&"consequence"===e.type).values().next()?.value;h||(h=await Item.create({name:c,type:"consequence",system:{specialized:!0,specialization:"describe injury",rank:1}}));let[u]=await this.createEmbeddedDocuments("Item",[h]);await u.update({"system.rank":n});let p=await d.generate_wound(s,i);new Dialog({title:`Describe ${c}`,content:`
                <form>
                    <div class="form-group">
                        <label for="descriptor">Descriptor</label>
                        <input type="text" name="descriptor" value="${p.descriptor}" autofocus>
                    </div>
                </form>`,buttons:{Confirm:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async e=>{let s=e.find("[name=descriptor]").val();p.descriptor!==s&&(p.description=""),await u.update({"system.specialization":s,"system.description":p.description})}}},default:"Confirm"}).render(!0)}async encumbrance_consequences(){if(this.isOwner){if(this.system.scores.encumbrance.value>this.system.scores.encumbrance.max){if(this.items.filter(e=>"Hindered"===e.name&&"Encumbered"===e.system.specialization&&"consequence"===e.type).length)return;let e=await k({name:"Hindered",actor:this,skip_actor:!0});[e]=await this.createEmbeddedDocuments("Item",[e]),await e.update({"system.specialization":"Encumbered","system.specialized":!0})}else{let e=this.items.filter(e=>"Hindered"===e.name&&"Encumbered"===e.system.specialization&&"consequence"===e.type);e.length&&await this.deleteEmbeddedDocuments("Item",e.map(e=>e.id))}}}is_pc(){return"character"===this.type&&!this.system.npc}is_npc(){return"character"===this.type&&!!this.system.npc}total_modifiers(e){return f.total_modifiers(this.modifiers(e))}modifiers(e){let s=null;return(e.base_score&&(s=foundry.utils.deepClone(this.system.modifiers.scores[e.base_score])),("Defense"===e.tn||"Willpower"===e.tn)&&(s=foundry.utils.deepClone(this.system.modifiers.other.attack)),s?.length||"defense"!==e.score&&"willpower"!==e.score||(s=foundry.utils.deepClone(this.system.modifiers.other.defense)),!s?.length&&e.stat&&(s=foundry.utils.deepClone(this.system.modifiers.stats[e.stat])),s||(s=[]),Array.isArray(s))?(e.boons&&s.push(`boons=${e.boons}`),e.banes&&s.push(`banes=${e.banes}`),e.modifier&&s.push(`modifier=${e.modifier}`),e.divide&&s.push(`divide=${e.divide}`),!r.is_attack(e)||r.is_power(e)||r.strength_met(e,this)||s.push("name=Low Str&banes=1"),("strength"===e.stat||"dexterity"===e.stat||"speed"===e.stat||"endurance"===e.stat)&&this.system.scores.health.fatigue&&this.system.scores.health.value>=this.system.scores.health.max&&s.push("name=Fatigue&banes=1"),("speed"===e.stat||"Athletics"===e.skill)&&this.system.scores.armor.properties.Bulky&&s.push("name=Bulky&banes=1"),"strength"===e.stat&&this.system.scores.armor.properties.Powered&&s.push("name=Powered&boons=2"),r.is_attack(e)&&r.has_property(e.properties,"Auto")&&s.push("name=Auto&boons=1"),f.parse(s)):(console.error("Mods object is not array"),[])}async test(e){let s=new b({actor:this,...e});return!1!==e.evaluate&&await s.evaluate(),!1!==e.apply_effects&&await s.apply_effects(e),e.chat&&await s.to_chat({whisper:!!e.whisper}),s}}class I{static async calculate_scores(e){e.system.scores.armor.properties=e.armor_properties(),e.system.scores.armor.custom||(e.system.scores.armor.value=e.calculate_score("armor",e.armor_value())),e.system.scores.defense.custom||(e.system.scores.defense.value=e.calculate_score("defense",[e.system.stats.dexterity.value,e.system.stats.speed.value,e.system.stats.perception.value])),e.system.scores.willpower.custom||(e.system.scores.willpower.value=e.calculate_score("willpower",[e.system.stats.intelligence.value,e.system.stats.charisma.value,e.system.stats.determination.value])),e.system.scores.health.custom||(e.system.scores.health.max=e.calculate_score("health",e.system.stats.strength.value+e.system.stats.endurance.value)),e.system.scores.health.value=e.wound_total(),e.system.scores.health.fatigue=I.fatigue(e),e.system.scores.move.custom||(e.system.scores.move.value=e.calculate_score("move",[e.system.stats.speed.value,e.system.stats.endurance.value,e.system.stats.determination.value],{modifier:-1*e.system.scores.armor.properties.Bulky||0,divide:e.system.scores.health.fatigue&&e.system.scores.health.value>=e.system.scores.health.max?2:1})),e.system.scores.encumbrance.custom||(e.system.scores.encumbrance.max=e.calculate_score("encumbrance",[e.system.stats.strength.value,e.system.stats.dexterity.value,e.system.stats.endurance.value],{modifier:e.system.scores.armor.properties.Powered||0})),e.system.scores.encumbrance.value=e.encumbrance_total();let s=I.experiences_spent(e);e.system.experiences.spent=s.total,e.system.experiences.spent_stats=s.stats,e.system.experiences.spent_skills=s.skills,e.system.experiences.spent_traits=s.traits,e.system.experiences.unspent=e.system.experiences.total-e.system.experiences.spent,e.system.experiences.level=I.power_level(e)}static fatigue(e){return e.items.filter(e=>"consequence"===e.type&&"fatigue"===e.name.toLowerCase()).map(e=>e.system.rank).reduce((e,s)=>e+s,0)}static luck_cost(e){return 6*e-30}static stat_cost(e,s=0){let i=s?[...Array(s+1).keys()].reduce((e,s)=>e+s,0):0;return[...Array(e+1).keys()].reduce((e,s)=>e+s,-1*i)}static experiences_spent(e){let s=0;for(let i of["strength","dexterity","speed","endurance","intelligence","perception","charisma","determination"])s+=I.stat_cost(e.system.stats[i].value);s-=game.settings.get("saga-machine","level",120);let i=0,a=0;for(let s of e.items)"skill"===s.type&&(i+=I.stat_cost(s.system.rank,s.system.free_ranks)),"trait"===s.type&&(a+=s.system.ranked?s.system.cost*s.system.rank:s.system.cost);return{total:s+i+a+I.luck_cost(e.system.scores.luck.max),stats:s,skills:i,traits:a}}static power_level(e){let s=e.system.experiences.spent+game.settings.get("saga-machine","level",120);return s<150?"Mundane":s<200?"Novice":s<250?"Exceptional":s<300?"Distinguished":s<350?"Renowned":"Legendary"}static parry_bonus(e){let s=e.items.filter(e=>"item"===e.type&&"Weapons"===e.system.group&&e.system.equipped),i=0;for(let e of s){let s=e.system.parry;s>i&&(i=s)}return i}static primary_weapon(e){let s=e.items.filter(e=>"item"===e.type&&"Weapons"===e.system.group&&e.system.equipped),i=null,a=0;for(let e of s){let s=Number(e?.system?.actions?.[0]?.system?.action_effects.filter(e=>"damage"===e.type)?.[0]?.value)||0;s>a&&(a=s,i=e)}return i}static async merge_attack_option(e){if("true"!==e.option)return e;{let s=await fromUuid(e.uuid);if(!s)return e;let i=I.primary_weapon(s);if(!i)return e;let a=i?.system?.actions?.[0];return a?{uuid:e.uuid,type:e.type,stat:e.stat||a.system.stat,skill:e.skill||a.system.stat,tn:e.tn,modifiers:r.merge_modifiers(a?.system?.modifiers,e.modifiers),properties:r.merge_properties(a?.system?.properties,e.properties,!0),effects:JSON.stringify(a.system.action_effects.concat(JSON.parse(e.effects)))}:e}}}class E{static async calculate_scores(e){e.system.wealth.total=E.wealth_total(e),e.system.encumbrance.value=e.encumbrance_total()}static wealth_total(e){return e.items.filter(e=>"item"===e.type).reduce((e,s)=>s.system.cost*s.system.quantity+e,0)+e.system.wealth.money}}class M{static async calculate_scores(e){e.system.scores.armor.properties=e.armor_properties(),e.system.scores.armor.custom||(e.system.scores.armor.value=e.calculate_score("armor",e.armor_value())),e.system.scores.handling.boons=(e.system.scores.handling.label.match(/\+/g)||[]).length,e.system.scores.handling.banes=(e.system.scores.handling.label.match(/-/g)||[]).length,e.system.scores.defense.custom||(e.system.scores.defense.tn=e.calculate_score("defense",10+e.system.scores.handling.boons-(e.system.scores.size.value+e.system.scores.handling.banes))),e.system.scores.health.custom||(e.system.scores.health.max=e.calculate_score("health",15*2**e.system.scores.size.value)),e.system.scores.health.value=e.wound_total(),e.system.scores.space.value=M.loads_total(e)}static loads_total(e){return e.items.filter(e=>"item"===e.type).reduce((e,s)=>s.system.loads+e,0)}}class A extends ContextMenu{_position={};defaultStyle={position:"absolute","z-index":"var(--z-index-tooltip)",width:"max-content","min-width":"100px","font-family":"var(--font-primary)","font-size":"var(--font-size-14)","box-shadow":"0 0 10px var(--color-border-dark)",cursor:"pointer"};bind(){this.element.on(this.eventName,this.selector,e=>{e.preventDefault();let{right:s,bottom:i}=e.currentTarget.getBoundingClientRect();this._position={left:s,top:i}}),super.bind()}_setPosition(e,s){let i=$("body");super._setPosition(e,i),i.css("position","fixed"),e.css(this.defaultStyle),this._position.left-=this.menu.width()??0,e.css(this._position)}}Hooks.once("init",async()=>{Handlebars.registerHelper("is_GM",()=>game.user.isGM),Handlebars.registerHelper("is_weapon",e=>"weapons"===e.system.group.toLowerCase()),Handlebars.registerHelper("is_wearable",e=>"armors"===e.system.group.toLowerCase()||"apparel"===e.system.group.toLowerCase()),await loadTemplates(["systems/saga-machine/templates/partials/character-header.html","systems/saga-machine/templates/partials/character-sidebar.html","systems/saga-machine/templates/partials/character-inventory.html"])});const L={Broke:"Broke",Poor:"Poor",Struggling:"Struggling",Average:"Average",Comfortable:"Comfortable",Wealthy:"Wealthy","Very Wealthy":"Very Wealthy","Filthy Rich":"Filthy Rich"},q={Stash:"Stash",Merchant:"Merchant"},R={common:"Common",uncommon:"Uncommon",rare:"Rare",exotic:"Exotic"},P={"++":"⊕⊕","+":"⊕","":"—","-":"⊖","--":"⊖⊖"};class V extends ActorSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["saga-machine","sheet","actor"],width:850,height:650,tabs:[{navSelector:".sheet-tabs",contentSelector:".sheet-body",initial:"basics"}],scrollY:[".basics",".combat",".inventory",".advancement"],dragDrop:[{dragSelector:".items-list .item",dropSelector:null}]})}get template(){return!game.user.isGM&&this.actor.limited?"systems/saga-machine/templates/actors/limited-sheet.html":`systems/saga-machine/templates/actors/${this.actor.type}-sheet.html`}getData(){let e=super.getData();return e.data.system.ambitions=this.items(e,"ambition",null,(e,s)=>e.system.type>s.system.type?1:-1),e.data.system.paths=this.items(e,"path"),e.data.system.origins=this.items(e,"origin"),e.data.system.all_skills=this.items(e,"skill"),e.data.system.skill_groups=this.skills_and_traits(e.data.system.all_skills,"General Skills"),e.data.system.all_traits=this.items(e,"trait"),e.data.system.trait_groups=this.skills_and_traits(e.data.system.all_traits,"General Traits",["General Traits","Weaknesses"]),e.data.system.consequences=this.items(e,"consequence"),e.data.system.equipment=this.items(e,"item"),e.data.system.containers=this.items(e,"item",e=>!!e.system.container),e}items(e,s,i,a){return i||(i=()=>!0),a||(a=(e,s)=>e.name>s.name?1:-1),e.actor.items.filter(e=>e.type===s&&i(e)).sort(a)}gather_actions(e){let s=this.items(e,"action");for(let i of e.actor.items.filter(e=>e.system.actions?.length&&(e.system.equipped||void 0===e.system.equipped)))for(let e of i.system.actions)s.push(new n(e,{parent:i,parentCollection:i.collection}));return s}skills_and_traits(e,s,i=null){let a=this.group_items(e,e=>e.system.group,null,null,s),n=[];if(i)for(let e of i)e in a||n.push({name:e,contents:[]});for(let e of Object.keys(a))n.push({name:e,contents:a[e]});return n.sort((e,i)=>e.name===i.name?0:e.name===s?-1:i.name===s?1:e.name<i.name?-1:e.name>i.name?1:0),n}groups_and_containers({context:e,top_groups:s=["Weapons","Armors"],blank:i="Miscellanea"}){let a=this.group_items(e.data.system.equipment,e=>e.system.parent||e.system.group,e=>!e.system.container);e.data.system.equipment.filter(e=>!e.system.parent&&!e.system.container).length||(a[i]=[]);let n=[];for(let s of e.data.system.containers)s.id in a||n.push({name:s.system.full_name,container:s,contents:[],encumbrance:0,max:s.system.container});for(let s of Object.keys(a)){let i=e.data.system.containers.find(e=>e.id===s);n.push({name:i?i.system.full_name:s,container:i||null,contents:a[s],encumbrance:a[s].reduce((e,s)=>e+s.system.container_encumbrance,0),max:i?i.system.container:0})}return n.sort((e,i)=>{if(e.name===i.name)return 0;for(let a of s){if(e.name===a)return -1;if(i.name===a)return 1}return e.container&&!i.container?1:i.container&&!e.container||e.name<i.name?-1:e.name>i.name?1:0}),n}group_items(e,s,i,a,n){i||(i=()=>!0),a||(a=(e,s)=>e.name>s.name?1:-1),n||(n="Miscellanea");let r=(e,s)=>s.split(".").reduce((e,s)=>e[s],e),o={};for(let a of e){if(!i(a))continue;let e="function"==typeof s?s(a):r(a,s);e&&"string"==typeof e||(e=n),e in o?o[e].push(a):o[e]=[a]}for(let e of Object.keys(o))o[e].sort(a);return o}calc_health_progress_bar(e){e.data.system.scores.health.max?e.data.system.scores.health.percent=Math.round(e.data.system.scores.health.value/e.data.system.scores.health.max*100):e.data.system.scores.health.percent=0}activateListeners(e){super.activateListeners(e),this.isEditable&&(e.find(".item-create").on("click",this.on_item_create.bind(this)),e.find(".item-edit").on("click",this.on_item_edit.bind(this)),e.find(".item-delete").on("click",this.on_item_delete.bind(this)),e.find(".item-remove").on("click",this.on_item_remove.bind(this)),e.find(".item-input").on("change",this.on_item_update.bind(this)),e.find(".expandable").on("click",this.expand_description.bind(this)),e.find(".chatable").on("click",this.chat_description.bind(this)),this.init_origins_menu(e),this.attach_drag_events(e),this.attach_drop_events(e))}_onDragStart(e){"Test"===e.currentTarget.dataset.type&&e.stopPropagation(),this.attach_uuid(e.currentTarget.dataset);let s={"key-alt":e.altKey,"key-ctrl":e.ctrlKey,"key-shift":e.shiftKey,"key-meta":e.metaKey};e.dataTransfer.setData("text/plain",JSON.stringify({...e.currentTarget.dataset,...s})),super._onDragStart(e)}async on_item_create(e){e.preventDefault();let s=$(e.currentTarget).data("type"),i={name:$(e.currentTarget).data("name")||`New ${s}`,type:s,system:$(e.currentTarget).data("system")||{}};return await Item.create(i,{parent:this.actor})}async on_item_edit(e){let s=$(e.currentTarget).parents(".item");this.actor.items.get(s.data("id")).sheet.render(!0)}async on_item_delete(e){let s=$(e.currentTarget).parents(".item"),i=this.actor.items.get(s.data("id"));if(i.system.container){let e=this.actor.items.filter(e=>"item"===e.type&&e.system.parent===i.id);await this.actor.updateEmbeddedDocuments("Item",e.map(e=>Object({_id:e.id,"system.parent":null})))}i.delete(),s.slideUp(200,()=>this.render(!1))}async on_item_remove(e){let s=$(e.currentTarget).parents(".item"),i={_id:this.actor.items.get(s.data("id")).id,"system.parent":null};this.actor.updateEmbeddedDocuments("Item",[i])}async on_item_update(e){let s=$(e.currentTarget).parents(".item"),i=e.currentTarget.getAttribute("data-name"),a={_id:s.data("id")};a[i]=Number(e.currentTarget.value),this.actor.updateEmbeddedDocuments("Item",[a])}async on_action_edit(e){let s=$(e.currentTarget).parents(".item");if("Actor"===s.data("parent-type"))await this.on_item_edit(e);else{let e=this.actor.items.get(s.data("parentId")),i=r.parent_action_index(e,s.data("id"));if(i>e.system.actions.length||i<0)return;new n(e.system.actions[i],{parent:e,parentCollection:e.collection}).sheet.render(!0)}}async on_action_delete(e){let s=$(e.currentTarget).parents(".item");if("Actor"===s.data("parent-type"))await this.on_item_delete(e);else{let e=this.actor.items.get(s.data("parentId")),i=r.parent_action_index(e,s.data("id"));e.system.actions.splice(i,1),e.update({"system.actions":e.system.actions}),s.remove()}}async expand_description(e){let s=null,i=$(e.target).closest(".item").find(".item-description");if(!i.length){let a=$(e.target).closest(".item").data("id");s=$(e.target).closest(".items-inline").find(".item-description"),i=$(e.target).closest(".items-inline").find(`.item-description[data-id='${a}']`)}if(s)for(let e of s)e!==i[0]&&$(e).is(":visible")&&$(e).slideUp(200);i.slideToggle(200)}async chat_description(e){let s=$(e.target).closest(".item").data("id");if(!s)return;let i=this.actor.items.get(s);i&&this.to_chat(i)}init_origins_menu(e){new A(e,".origins-add",[{name:"Origin",icon:'<img class="menu-img" src="systems/saga-machine/images/defaults/origin.svg" />',condition:!0,callback:e=>(Item.create({name:"New Origin",type:"origin"},{parent:this.actor}),console.log(this),!0)},{name:"Path",icon:'<img class="menu-img" src="systems/saga-machine/images/defaults/path.svg" />',condition:!0,callback:e=>{Item.create({name:"New Path",type:"path"},{parent:this.actor})}}],{eventName:"click"})}attach_drag_events(e){e.find(".rollable").each((e,s)=>{s.setAttribute("draggable",!0),s.addEventListener("dragstart",e=>this._onDragStart(e),!1)}),e.find(".items-list .item input, .items-list .item select").on("mousedown",function(e){e.stopPropagation(),$(e.target).closest(".item").attr("draggable",!1)}),e.find(".items-list .item").on("mousedown",function(e){$(e.target).attr("draggable",!0)}).on({dragstart:function(e){e.stopPropagation();let s=e.originalEvent.dataTransfer;s&&(s.effectAllowed="move",s.setData("text/html",""))}})}attach_drop_events(e){e.find(".item-group").on("drop",async e=>{let s=null;try{s=JSON.parse(e.originalEvent.dataTransfer.getData("text"))}catch(e){}if(!s||!s.uuid||"Item"!==s.type)return;let i=await fromUuid(s.uuid);if("item"!==i.type)return;let a=$(e.currentTarget).data("id");a&&(i.system.container_encumbrance+$(e.currentTarget).data("encumbrance")<=$(e.currentTarget).data("max")?await i.update({"system.parent":a}):await i.update({"system.parent":null}))})}async on_score_toggle(e){e.preventDefault();let s=$(e.target);s.hasClass("score-secondary")?this.adjust_score(s,-1):this.toggle_custom(s)}async on_score_increment(e){e.preventDefault();let s=$(e.target);s.hasClass("score-secondary")&&this.adjust_score(s,1)}attach_uuid(e){e.uuid||(e.uuid=this.actor.uuid)}adjust_score(e,s){let i=e.attr("name"),a=this.get_score(i,[]),n={};n[i]=a+s,this.actor.update(n)}toggle_custom(e){let s=e.hasClass("score-input")?e:e.find(".score-input");if(!s.length)return;let i=s.attr("name"),a=this.get_score(i,["max","value","tn"]);if(!a)return;s.prop("disabled",!!a.custom);let n=this.get_score_custom(i),r={};r[n]=!a.custom,this.actor.update(r)}get_score(e,s){let i=e.split("."),a=this.actor;for(let e of i)if(a&&!s.includes(e))a=a[e]?a[e]:null;else break;return a}get_score_custom(e){return e.substring(0,e.lastIndexOf("."))+".custom"}to_chat(e){ChatMessage.create({flavor:`<header class="item-header"><img src="${e.img}" alt="${e.name}" /><h2>${e.name}</h2></header>`,content:e.system.description,speaker:ChatMessage.getSpeaker({actor:this.actor})})}async on_test(e){e.preventDefault(),this.attach_uuid(e.currentTarget.dataset);let s=await I.merge_attack_option(e.currentTarget.dataset);await w(s)}}class j extends V{get template(){return!game.user.isGM&&this.actor.limited?"systems/saga-machine/templates/actors/limited-sheet.html":this.actor.is_pc()?"systems/saga-machine/templates/actors/pc-sheet.html":"systems/saga-machine/templates/actors/npc-sheet.html"}getData(){let e=super.getData();return e.data.system.scores.luck.label=game.settings.get("saga-machine","luck_label","Luck"),e.data.system.LIFESTYLES=L,e.data.system.equipment_groups=this.groups_and_containers({context:e,top_groups:["Weapons","Armors"],blank:"Miscellanea"}),e.data.system.actions=this.gather_actions(e),e.data.system.action_groups=this.skills_and_traits(e.data.system.actions,"Attacks"),this.calc_health_progress_bar(e),e.data.system.defenses=this.gather_defenses(e),e}activateListeners(e){super.activateListeners(e),this.isEditable&&(e.find(".rollable").click(this.on_test.bind(this)),e.find(".score").on("contextmenu",this.on_score_toggle.bind(this)),e.find(".score").on("click",this.on_score_increment.bind(this)),e.find(".item-equip").click(this.on_item_equip.bind(this)),e.find(".item-carry").click(this.on_item_carry.bind(this)),e.find(".items-inline > .item").on("contextmenu",this.on_npc_edit.bind(this)),e.find(".defense-test").on("click",this.on_defense_test.bind(this)),e.find(".dodge-toggle").on("click",this.on_dodge.bind(this)),e.find(".parry-toggle").on("click",this.on_parry.bind(this)),e.find(".resist-toggle").on("click",this.on_resist.bind(this)),e.find(".action-edit").on("click",this.on_action_edit.bind(this)),e.find(".action-delete").on("click",this.on_action_delete.bind(this)))}async on_dodge(e){e.preventDefault();let s=!this.actor.system.scores.defense.dodge_on;this.actor.system.scores.defense.parry_on&&await this.on_parry(e);let i=async e=>{e.total>this.actor.system.scores.defense.tn&&await this.actor.update({"system.scores.defense.tn":e.total,"system.scores.defense.dodge_on":!0,"system.scores.defense.round_tn":this.actor.system.scores.defense.tn})};if(s){let e={type:"Test",score:"defense"};this.attach_uuid(e),await w(e,i)}else await ChatMessage.create({flavor:`<div>Removing Dodge.</div><div><strong>Defense TN:</strong> ${this.actor.system.scores.defense.round_tn}</div>`,whisper:game.users.filter(e=>e.character?.id===this.actor?.id).map(e=>e.id),speaker:ChatMessage.getSpeaker({actor:this.actor})}),await this.actor.update({"system.scores.defense.tn":this.actor.system.scores.defense.round_tn,"system.scores.defense.dodge_on":!1})}async on_resist(e){e.preventDefault();let s=!this.actor.system.scores.willpower.resist_on,i=async e=>{e.total>this.actor.system.scores.willpower.tn&&await this.actor.update({"system.scores.willpower.tn":e.total,"system.scores.willpower.resist_on":!0,"system.scores.willpower.round_tn":this.actor.system.scores.willpower.tn})};if(s){let e={type:"Test",score:"willpower"};this.attach_uuid(e),await w(e,i)}else await ChatMessage.create({flavor:`<div>Removing Resist.</div><div><strong>Willpower TN:</strong> ${this.actor.system.scores.willpower.round_tn}</div>`,whisper:game.users.filter(e=>e.character?.id===this.actor?.id).map(e=>e.id),speaker:ChatMessage.getSpeaker({actor:this.actor})}),await this.actor.update({"system.scores.willpower.tn":this.actor.system.scores.willpower.round_tn,"system.scores.willpower.resist_on":!1})}async on_parry(e){this.actor.system.scores.defense.dodge_on&&await this.on_dodge(e);let s=!this.actor.system.scores.defense.parry_on,i=I.parry_bonus(this.actor),a=s?this.actor.system.scores.defense.tn+i:this.actor.system.scores.defense.tn-i;s?await ChatMessage.create({flavor:`<div>${this.actor.name} Parries!</div><div><strong>Defense TN:</strong> ${a}</div>`,speaker:ChatMessage.getSpeaker({actor:this.actor})}):await ChatMessage.create({flavor:`<div>Removing Parry bonus.</div><div><strong>Defense TN:</strong> ${a}</div>`,whisper:game.users.filter(e=>e.character?.id===this.actor?.id).map(e=>e.id),speaker:ChatMessage.getSpeaker({actor:this.actor})}),await this.actor.update({"system.scores.defense.tn":a,"system.scores.defense.parry_on":s})}async on_defense_test(e){let s=this.actor.system.scores.defense.test;if(s){for(let e of this.gather_actions(this))if(e.id===s){let s={type:"Test",stat:e.system.stat,skill:e.system.skill,tn:e.system.tn,modifiers:e.system.modifiers,properties:e.system.properties,effects:e.sheet.effects_str};return this.attach_uuid(s),await w(s)}}else await this.on_test(e)}gather_defenses(e){let s=[];for(let i of e.data.system.actions)r.is_defense(i.system.action_effects)&&s.push(i);return s}async on_item_equip(e){let s=$(e.currentTarget).parents(".item"),i=this.actor.items.get(s.data("id")),a={_id:i.id,"system.equipped":!i.system.equipped};this.actor.updateEmbeddedDocuments("Item",[a])}async on_item_carry(e){let s=$(e.currentTarget).parents(".item"),i=this.actor.items.get(s.data("id")),a={_id:i.id,"system.carried":!i.system.carried};this.actor.updateEmbeddedDocuments("Item",[a])}async on_npc_edit(e){e.preventDefault();let s=$(e.currentTarget).closest(".item");this.actor.items.get(s.data("id")).sheet.render(!0)}}class H extends V{getData(){let e=super.getData();return e.data.system.STASH_TYPES=q,e.data.system.equipment_groups=this.groups_and_containers({context:e,top_groups:["Weapons","Armors"],blank:"Miscellanea"}),e}activateListeners(e){super.activateListeners(e),this.isEditable&&e.find(".distribute-money").on("click",this.distribute_money.bind(this))}async distribute_money(){let e=game?.canvas?.tokens?.controlled;if(!e.length)return ui.notifications.warn("No valid character selected.");let s=this.actor.system.wealth.money%e.length,i=Math.floor(this.actor.system.wealth.money/e.length);for(let a of e)a.actor.isOwner?a.actor.update({"system.wealth.money":a.actor.system.wealth.money+i}):s+=i;this.actor.update({"system.wealth.money":s});let a="<li>"+e.map(e=>`@UUID[${e.actor.uuid}]{${e.name}}`).join("</li><li>")+"</li>";ChatMessage.create({content:`<strong>${i}\xa4</strong> each distributed from @UUID[${this.actor.uuid}]{${this.actor.name}} to:<ul style="line-height: 1.7em">${a}</ul>`})}}class F extends V{async getData(){let e=super.getData();return e.data.system.is_pc=this.actor.hasPlayerOwner,e.data.system.VEHICLE_AVAILABILITY=R,e.data.system.VEHICLE_HANDLING=P,e.data.system.equipment_groups=this.groups_and_containers({context:e,top_groups:["Vehicle Components","Trade Goods"],blank:"Trade Goods"}),e.data.system.actions=this.gather_actions(e),e.data.system.action_groups=this.skills_and_traits(e.data.system.actions,"Attacks"),await this.lookup_crew(e),this.calc_health_progress_bar(e),this.calc_space_progress_bar(e),e}async activateListeners(e){super.activateListeners(e),await this.draw_positions(e),this.isEditable&&(e.find(".rollable").click(this.on_test.bind(this)),e.find(".score").on("contextmenu",this.on_score_toggle.bind(this)),e.find(".score").on("click",this.on_score_increment.bind(this)),e.find(".position-list .lock-toggle").click(this.toggle_lock.bind(this)),e.find(".position-list .position-row").on("drop",this.drop_crewman.bind(this)),e.find(".position-list img.crewman").click(this.open_crewman.bind(this)),e.find(".position-list .crew-delete").click(this.delete_crewman.bind(this)),e.find(".position-list .position-create").click(this.add_position.bind(this)),e.find(".position-list .position-delete").click(this.delete_position.bind(this)),e.find(".action-crewman").on("change",this.on_action_crewman.bind(this)),e.find(".action-edit").on("click",this.on_action_edit.bind(this)),e.find(".action-delete").on("click",this.on_action_delete.bind(this)))}calc_space_progress_bar(e){e.data.system.scores.space.max?e.data.system.scores.space.percent=Math.round(e.data.system.scores.space.value/e.data.system.scores.space.max*100):e.data.system.scores.space.percent=0}async on_test(e){e.preventDefault();let s=$(e.currentTarget).closest(".item, .position").find("select.action-crewman, input[name=character]").val();e.currentTarget.dataset.uuid=s||this.actor.uuid,await w({...e.currentTarget.dataset,...s?{}:{score:"crew",stat:null,skill:null}})}async lookup_crew(e){for(let s of e.data.system.scores.crew.positions)s.character&&(s.actor=await fromUuid(s.character),s.label=`${s.actor.name} (${s.position})`);e.data.system.scores.crew.roster=e.data.system.scores.crew.positions.filter(e=>e.character)}on_action_crewman(e){e.preventDefault(),e.stopPropagation()}async drop_crewman(e){let s=null;try{s=JSON.parse(e.originalEvent?.dataTransfer?.getData("text"))}catch(e){}if(!s||!s.uuid||"Actor"!==s.type)return;let i=await fromUuid(s.uuid);"character"===i.type&&($(e.currentTarget).closest(".position").find("input[name=character]").val(i.uuid),this.update_positions(e))}async open_crewman(e){let s=$(e.currentTarget).data("uuid");(await fromUuid(s)).sheet.render(!0)}async delete_crewman(e){$(e.currentTarget).closest(".character").find("input[name=character]").val(""),this.update_positions(e)}toggle_lock(e){let s=$(e.currentTarget).closest(".lock-toggle"),i=s.closest(".position-list");s.hasClass("locked")?(s.removeClass("locked").find("i").removeClass("fa-lock").addClass("fa-unlock"),i.find(".position-create").removeClass("hidden"),i.find(".position-delete").removeClass("hidden"),i.find("select").removeAttr("disabled")):(s.addClass("locked").find("i").removeClass("fa-unlock").addClass("fa-lock"),i.find(".position-create").addClass("hidden"),i.find(".position-delete").addClass("hidden"),i.find("select").attr("disabled","disabled"))}async add_position(e){if(!this.isEditable)return;let s=this.element.find(".position.prototype"),i=this.element.find("ol.position-list");if(!s||!s.length||!i||!i.length)return;let a=s.clone();a.removeClass("prototype"),a.find("input, select").change(this.update_positions.bind(this)),i.append(a),this.update_positions(e)}async delete_position(e){let s=$(e.currentTarget).closest(".position"),i=s.closest(".position-list");s.remove(),this.update_positions(e,i)}async draw_positions(e){if(!this.actor.system.scores.crew.positions||!this.actor.system.scores.crew.positions.length)return;let s=e.find(".position.prototype"),i=e.find("ol.position-list");if(s&&s.length&&i&&i.length)for(let e of this.actor.system.scores.crew.positions){let a=s.clone();if(a.removeClass("prototype"),a.find("[name=position]").val(e.position),a.find("[name=character]").val(e.character),e.character){let s=await fromUuid(e.character);a.find(".character").addClass("filled"),a.find("img.crewman").attr("src",s.img).data("uuid",s.uuid),a.find("div.character-label").text(s.name)}i.append(a),this.isEditable&&(a.find("input, select").change(this.update_positions.bind(this)),"Captain"===e.position?a.find(".position-actions").html(F.position_action_button("Coordinate","charisma","Persuade",12)+F.position_action_button("Inspire","perception","Empathy",12)):"Driver/Pilot"===e.position?a.find(".position-actions").html(F.position_action_button("Regain Control","speed","Vehicles",12)+F.position_action_button("Evasive Actions","speed","Vehicles","")+F.position_action_button("Close","speed","Vehicles","",null,"Vehicles vs. Vehicles")+F.position_action_button("Escape","speed","Vehicles","",null,"Vehicles vs. Vehicles")+F.position_action_button("On Alert","speed","Vehicles",12)):"Engineer"===e.position?a.find(".position-actions").html(F.position_action_button("Reroute Power","intelligence","Academics (Engineering)",12,"academics")+F.position_action_button("Boost","intelligence","Academics (Engineering)",12,"academics")):"Gunner"===e.position?a.find(".position-actions").html(F.position_action_button("Point Defense","dexterity","Projectiles","",null,"Projectiles vs. Projectiles")):"Jammer"===e.position?a.find(".position-actions").html(F.position_action_button("Jam","intelligence","Academics (Computing)",12,"academics")+F.position_action_button("Unjam","intelligence","Academics (Computing)",12,"academics")+F.position_action_button("Countermeasures","intelligence","Academics (Computing)","","academics","Academics (Computing) vs. Academics (Computing)")):"Marine"===e.position?a.find(".position-actions").html(F.position_action_button("Board","strength","Athletics",12)):"Mechanic"===e.position?a.find(".position-actions").html(F.position_action_button("Repair","dexterity","Trade (Mechanic)",10,"trade")+F.position_action_button("Jury-rig","dexterity","Trade (Mechanic)",12,"trade")+F.position_action_button("Recalibrate","dexterity","Trade (Mechanic)",12,"trade")):"Medic"===e.position&&a.find(".position-actions").html(F.position_action_button("Treat","dexterity","Medicine",10,null,"Dex/Medicine-10")+F.position_action_button("Counsel","perception","Empathy",12)))}}static position_action_button(e,s,i,a,n=null,r=null){return n||(n=i.toLowerCase()),r||(r=`${i}-${a}`),`<span class="item-img rollable" data-type="Test" data-stat="${s}" data-skill="${i}" data-tn="${a}" draggable="true">
				    <img class="item-img" src="systems/saga-machine/images/skills/${n}.svg" title="${e}: ${r} test">
				    <img class="item-img" src="systems/saga-machine/images/d10.svg" title="${e}: ${r} test">
			    </span>`}async update_positions(e,s=null){e.preventDefault(),e.stopPropagation();let i=$(e.currentTarget).closest("ol.position-list"),a=!!i.find(".lock-toggle").hasClass("locked"),n=s?s.find(".position:not(.prototype)"):i.find(".position:not(.prototype)"),r=[];n.each((e,s)=>{let i=$(s).find("[name=position]").val().trim(),a=$(s).find("[name=character]").val().trim();r.push({position:i,character:a})}),await this.actor.update({"system.scores.crew.positions":r}),a||setTimeout(()=>this.element.find(".lock-toggle").trigger("click"),10)}}const B={"Long-term":"Long-term","Short-term":"Short-term",Party:"Party",Quest:"Quest"},W={"":"--",strength:"Strength",dexterity:"Dexterity",speed:"Speed",endurance:"Endurance",intelligence:"Intelligence",perception:"Perception",charisma:"Charisma",determination:"Determination"},z={common:"Common",uncommon:"Uncommon",rare:"Rare",exotic:"Exotic"};class U extends ItemSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["saga-machine","sheet","item"],width:600,height:360,tabs:[{navSelector:".sheet-tabs",contentSelector:".sheet-body",initial:"basics"}],scrollY:[".basics",".actions","effects",".description"]})}get template(){return`systems/saga-machine/templates/items/${this.item.type}-sheet.html`}getData(){return super.getData()}activateListeners(e){super.activateListeners(e),this.isEditable&&(e.find(".actions .item-create").click(this.add_action.bind(this)),e.find(".actions .action-edit").click(this.edit_action.bind(this)),e.find(".actions .action-delete").click(this.delete_action.bind(this)))}toggle_items_provided(e){e.preventDefault(),$(e.target).parent().find(".items-provided").each((e,s)=>{$(s).is(":visible")?s.style.display="none":s.style.display="block"})}async on_create_effect(e){return e.preventDefault(),await ActiveEffect.create({name:"New Effect"},{parent:this.item})}async on_edit_effect(e){let s=$(e.target).closest(".effect"),i=s.data("id"),a=s.data("name"),n=i?this.item.effects.get(i):this.item.effects.getName(a);n&&n.sheet.render(!0)}async on_delete_effect(e){let s=$(e.target).closest(".effect"),i=s.data("id"),a=s.data("name");(i?this.item.effects.get(i):this.item.effects.getName(a)).delete(),s.slideUp(200,()=>this.render(!1))}async on_toggle_effect(e){let s=$(e.target).closest(".effect"),i=s.data("id"),a=s.data("name"),n=i?this.item.effects.get(i):this.item.effects.getName(a);n.update({disabled:!n.disabled})}add_action(){if(!this.isEditable)return;let e={name:this.item.name,type:"action",_id:btoa(Number(1e4*Math.random()).toString()).substring(1,17),img:this.item.img,system:{}};this.item.system.description&&(e.system.description=this.item.system.description),"item"===this.item.type&&(e.system.properties=this.item.system.properties,"Weapons"===this.item.system.group&&(e.system.group="Attacks")),"skill"===this.item.type&&(e.system.skill=this.item.system.full_name,e.system.stat=this.item.system.default,"Powers"===this.item.system.group&&(e.system.group="Powers"),"Maneuvers"===this.item.system.group&&(e.system.group="Attacks"),"Opening Moves"===this.item.system.group&&(e.system.group="Attacks"),"Stances"===this.item.system.group&&(e.system.group="Attacks"));let s=new n(e,{parent:this.item,parentCollection:this.item.collection});this.item.system.actions.push(s.toJSON()),this.item.update({"system.actions":this.item.system.actions})}edit_action(e){let s=$(e.target).closest(".action").data("id");s>this.item.system.actions.length||new n(this.item.system.actions[s],{parent:this.item,parentCollection:this.item.collection}).sheet.render(!0)}delete_action(e){let s=$(e.target).closest(".action"),i=s.data("id");this.item.system.actions.splice(i,1),this.item.update({"system.actions":this.item.system.actions}),s.remove()}items_provided(e,s){if(!s)return"&horbar;";let i=[];for(let a of s.split(",").map(e=>e.trim())){let s=this.matching_item(e,a),[n,r,o,l]=[s.item,s.name,s.specialization,s.rank];n?i.push(`<a class="content-link" draggable="true" data-uuid="${n.uuid}" data-id="${n.id}" data-type="Item" data-specialization="${o}" data-rank="${l}" data-tooltip="Item"><i class="fas fa-suitcase"></i>${a}</a>`):i.push(`<a class="content-link broken" draggable="true" data-type="${e}" data-name="${r}" data-specialization="${o}" data-rank="${l}"><i class="fas fa-unlink"></i>${a}</a>`)}return i.join(", ")}matching_item(e,s){let i=s.split(" "),a=i[i.length-1];isNaN(Number(a))&&(a="");let n=s.match(/\(([^\)]+)\)/);n=n?n[n.length-1]:"";let r=s.slice(0,s.length-a.length);(i=r.split("(")).length>1&&(r=i[0]),r=r.trim();let o=game.items.filter(s=>s.type===e&&s.name===r);return o.length?{item:o[0],name:r,specialization:n,rank:a}:{item:null,name:r,specialization:n,rank:a}}}class G extends U{getData(){let e=super.getData();return e.data.system.SKILL_DEFAULTS=W,e}activateListeners(e){if(super.activateListeners(e),!this.isEditable)return}}class J extends U{activateListeners(e){super.activateListeners(e),this.isEditable&&(e.find(".effect-create").on("click",this.on_create_effect.bind(this)),e.find(".effect-edit").on("click",this.on_edit_effect.bind(this)),e.find(".effect-delete").on("click",this.on_delete_effect.bind(this)),e.find(".effect-toggle").on("click",this.on_toggle_effect.bind(this)))}}class K extends U{getData(){let e=super.getData();return e.data.system.skills_provided=this.items_provided("skill",e.data.system.skills),e.data.system.traits_provided=this.items_provided("trait",e.data.system.traits),e.data.system.equipment_provided=this.items_provided("item",e.data.system.equipment),e}activateListeners(e){super.activateListeners(e),this.isEditable&&e.find(".items-provided").on("contextmenu",this.toggle_items_provided.bind(this))}}class Y extends U{getData(){let e=super.getData();return e.data.system.skills_provided=this.items_provided("skill",e.data.system.skills),e.data.system.traits_provided=this.items_provided("trait",e.data.system.traits),e.data.system.equipment_provided=this.items_provided("item",e.data.system.equipment),e}activateListeners(e){super.activateListeners(e),this.isEditable&&e.find(".items-provided").on("contextmenu",this.toggle_items_provided.bind(this))}}class X extends U{activateListeners(e){super.activateListeners(e),this.isEditable&&(e.find(".effect-create").on("click",this.on_create_effect.bind(this)),e.find(".effect-edit").on("click",this.on_edit_effect.bind(this)),e.find(".effect-delete").on("click",this.on_delete_effect.bind(this)),e.find(".effect-toggle").on("click",this.on_toggle_effect.bind(this)))}}class Q extends U{getData(){let e=super.getData();return e.data.system.ITEM_AVAILABILITY=z,e}activateListeners(e){if(super.activateListeners(e),!this.isEditable)return}}class Z extends U{getData(){let e=super.getData();return e.data.system.AMBITION_TYPES=B,e}}class ee extends U{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{width:550,height:600})}getData(){let e=super.getData();return e.data.system.STAT_OPTIONS=y,e.data.system.SCORE_OPTIONS=v,e}activateListeners(s){if(super.activateListeners(s),!this.isEditable)return;for(let i of s.find(".tag-input"))"system.modifiers"===i.getAttribute("name")&&Array.isArray(this.item.system.modifiers)&&(i.value=this.item.system.modifiers.join(",")),"system.properties"===i.getAttribute("name")&&Array.isArray(this.item.system.properties)&&(i.value=this.item.system.properties.join(",")),new(e(g))(i,{duplicates:!0,transformTag:e=>{e.style=f.color(e.value),isNaN(parseInt(e.value.split(" ").at(-1)))&&(e.value=e.value.replaceAll("+","⊕").replaceAll("-","⊖"))}});let i=s.find("select.stat[name='system.stat']"),a=s.find("select.score[name='system.stat']");i.on("change",()=>a.val("")),a.on("change",()=>i.val("")),this.draw_effects(s),s.find(".action-row .item-create").click(this.add_effect.bind(this)),s.find(".action-row .item-delete").click(this.delete_effect.bind(this))}_getSubmitData(e={}){let s=super._getSubmitData(e);if("system.stat"in s&&Array.isArray(s["system.stat"])&&s["system.stat"].length>=2&&(s["system.stat"]=s["system.stat"][0]?s["system.stat"][0]:s["system.stat"][1]),"system.modifiers"in s)try{s["system.modifiers"]=JSON.parse(s["system.modifiers"]).map(e=>e.value)}catch{}if("system.properties"in s)try{s["system.properties"]=JSON.parse(s["system.properties"]).map(e=>e.value)}catch{}return s}async _onSubmit(e,{updateData:s=null,preventClose:i=!1,preventRender:a=!1}={}){if(e.preventDefault(),!(this.item.parent instanceof n))return super._onSubmit(e,{updateData:s,preventClose:i,preventRender:a});{let e=this._getSubmitData(s);"consequence_name"in e&&delete e.consequence_name,"consequence_subject"in e&&delete e.consequence_subject,"damage_type"in e&&delete e.damage_type,"damage_value"in e&&delete e.damage_value,"effect_target"in e&&delete e.effect_target,"effect_type"in e&&delete e.effect_type,"effect_when"in e&&delete e.effect_when,"message_key"in e&&delete e.message_key,"message_value"in e&&delete e.message_value,foundry.utils.mergeObject(this.item,e);let i=r.parent_action_index(this?.item?.parent,this.item.id);if(i>=0)return this.item.parent.system.actions[i]=this.item.toObject(!1),await this.item.parent.update({"system.actions":this.item.parent.system.actions})}}draw_effects(e){if(!this.item.system.action_effects||!this.item.system.action_effects.length)return;let s=e.find(".action-effect.prototype"),i=e.find("ol.action-list");if(s&&s.length&&i&&i.length)for(let e of this.item.system.action_effects){let a=s.clone();a.removeClass("prototype"),a.find("[name=effect_type]").val(e.type),"damage"===e.type&&a.find("[name=damage_value]").val(e.value),"damage"===e.type&&a.find("[name=damage_type]").val(e.damage_type),"consequence"===e.type&&a.find("[name=consequence_name]").val(e.name),"consequence"===e.type&&a.find("[name=consequence_subject]").val(e.subject),"message"===e.type&&a.find("[name=message_key]").val(e.key),"message"===e.type&&a.find("[name=message_value]").val(e.value),a.find("[name=effect_when]").val(e.when),a.find("[name=effect_target]").val(e.target),this.change_effect_type(a),i.append(a),this.isEditable&&a.find("input, select").change(this.update_effects.bind(this))}}change_effect_type(e){let s=e.find("[name=effect_type]").val(),i=e.find(".action-props").children();if(e.length&&s&&i.length)for(let e of i)e.classList.contains(`action-${s}`)?e.classList.remove("hidden"):e.classList.add("hidden")}add_effect(){if(!this.isEditable)return;let e=this.element.find(".action-effect.prototype"),s=this.element.find("ol.action-list");if(!e||!e.length||!s||!s.length)return;let i=e.clone();i.removeClass("prototype"),i.find("input, select").change(this.update_effects.bind(this)),s.append(i)}delete_effect(e){let s=$(e.currentTarget).closest(".action-effect"),i=s.closest(".action-list");s.remove(),this.update_effects(e,i)}async update_effects(e,s=null){e.preventDefault(),e.stopPropagation();let i=s?s.find(".action-effect:not(.prototype)"):$(e.currentTarget).closest("ol.action-list").find(".action-effect:not(.prototype)"),a=[];i.each((e,s)=>{let i=$(s).find("[name=effect_type]").val().trim(),n=$(s).find("[name=damage_value]").val().trim(),r=$(s).find("[name=damage_type]").val().trim(),o=$(s).find("[name=consequence_name]").val().trim(),c=$(s).find("[name=consequence_subject]").val().trim(),d=$(s).find("[name=message_key]").val().trim(),h=$(s).find("[name=message_value]").val().trim(),u={type:i,when:$(s).find("[name=effect_when]").val().trim(),target:$(s).find("[name=effect_target]").val().trim()};"damage"===i?u={value:n,damage_type:r,...u}:"consequence"===i?u={name:o,subject:c||null,...u}:"message"===i&&(u={key:d||null,value:h,...u});try{a.push(l.to_json(new l(u)))}catch(e){}}),this.item.parent instanceof n?(await this.submit({updateData:{"system.action_effects":a}}),await this.render()):this.item.update({"system.action_effects":a})}get effects_str(){return JSON.stringify(this.item.system.action_effects.map(e=>l.to_json(e)))}}async function et(e,s){if("Test"!==e.type)return;let a=i(e);if(!a)return ui.notifications.warn("You can only create macro buttons for known actors");let n=new b({actor:a,stat:(e=await I.merge_attack_option(e)).stat||e.score,skill:e.skill,tn:e.tn}).label,r=null;e.skill&&(r=a.items.find(s=>s.name===e.skill&&"skill"===s.type));let o=JSON.stringify(e,null,4),l=`game.sagamachine.sm_test_macro(${o});`,c=game.macros.find(e=>e.name===n&&e.command===l),d={name:n,type:"script",command:l,flags:{"sagamachine.sm_test_macro":!0}};return r&&(d.img=r.img),c||(c=await Macro.create(d)),await game.user.assignHotbarMacro(c,s),!1}async function es(e){let s=i(e);if(!s){let i=ChatMessage.getSpeaker();i.token&&(s=game.actors.tokens[i.token]),s||(s=game.actors.get(i.actor)),e.uuid=s.uuid}await w(e)}async function ei(e){if(!e.find(".damage").length)return;let s=!!e.find(".critical").length,i=[];e.find(".damage").each((e,a)=>{let n=Number($(a).text()),r=$(a).parent().find(".damage-type").text(),o=Number($(a).data("pierce"))||0;i.push({damage:n,damageType:r,critical:s,pierce:o}),s=!1}),e[0].setAttribute("draggable",!0),e[0].addEventListener("dragstart",e=>{e.currentTarget.dataset.hits=JSON.stringify(i),e.dataTransfer.setData("text/plain",JSON.stringify({hits:i}))},!1)}async function ea(e,s){if(s.hits)for(let i of s.hits)await e.apply_damage(i.damage,i.damageType,i.critical,i.pierce)}async function en(e){e.push({name:"Push Your Luck",icon:'<i class="fas fa-dice"></i>',condition:e=>!!e.find(".test-json").length,callback:async e=>{let s=b.from_json(JSON.parse(e.find(".test-json").val()));return s?.actor?.isOwner?s?.actor?.system?.scores?.luck?.value<=0?ui.notifications.warn("The character doesn't have enough Luck."):void(s.boons++,s.use_luck=!0,await s.evaluate(),s.actor.update({"system.scores.luck.value":s.actor.system.scores.luck.value-1}),await s.apply_effects(),await s.to_chat({whisper:e.hasClass("whisper"),rolls:[s.results]})):ui.notifications.warn("You can't Push Your Luck for this character.")}})}async function er(e){e.push({name:"Apply Damage",icon:'<i class="fas fa-user-minus"></i>',condition:e=>!!e.find(".damage").length,callback:e=>{let s=game?.canvas?.tokens?.controlled;if(!s.length&&game.user.isGM){ui.notifications.warn("No valid character selected.");return}let i=s.filter(e=>e?.document?.actor?.isOwner);for(let s of(!i.length&&game.user.character&&(i=[game.user.character]),i)){let i=s?.document?.actor;if(i&&i.isOwner){let s=!!e.find(".critical").length;e.find(".damage").each((e,a)=>{let n=Number($(a).text()),r=$(a).parent().find(".damage-type").text(),o=Number($(a).data("pierce"))||0;i.apply_damage(n,r,s,o),s=!1})}}}})}async function eo(e){e.push({name:"Edit Results",icon:'<i class="fa fa-edit"></i>',condition:e=>game.user.isGM,callback:e=>{let s=e.data("messageId"),i=b.from_json(JSON.parse(e.find(".test-json").val()));new Dialog({title:"Edit Results",content:`
                    <form class="saga-machine">
                        <div class="form-group">
                            <label for="critical">Success</label>
                            <input type="checkbox" name="success" ${i.success?"checked":""}>
                        </div>
                        <div class="form-group">
                            <label for="critical">Critical</label>
                            <input type="checkbox" name="critical" ${i.critical?"checked":""}>
                        </div>
                        <div class="form-group">
                            <label for="value">Margin</label>
                            <input type="number" name="margin" value="${i.margin}" autofocus>
                        </div>
                        <div class="sheet-body">
                            <ol class="items-list consequence-list">
                                <li class="item flexrow items-header consequence-row">
                                    <div class="item-name">Type</div>
                                    <div class="item-name">Value</div>
                                    <div class="item-controls">
                                        <a class="item-control item-create" title="Create effect"><i class="fas fa-plus"></i> Add</a>
                                    </div>
                                </li>
                
                                <li class="item flexrow consequence consequence-row prototype">
                                    <select class="item-input item-name" name="type">
                                        <option value="damage">Damage</option>
                                        <option value="consequence">Consequence</option>
                                        <option value="defense">Defense</option>
                                        <option value="message">Message</option>
                                    </select>
                                    <input class="item-input item-name" type="text" name="value" value="" />
                                    <div class="item-controls">
                                        <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                                    </div>
                                </li>
                            </ol>
                        </div>
                    </form>`,render:e=>{if(i.effects&&i.effects.length){let s=e.find(".consequence.prototype"),a=e.find("ol.consequence-list");for(let e of i.effects){let n=null;switch(e.type){case"consequence":n=e.name;break;case"damage":n=`${Number(e.value)+(Number(e.margin)||Number(i.margin))} ${e.damage_type} ${e.properties}`;break;case"message":n=`${e.key}: ${e.value}`;break;default:n=""}let r=s.clone();r.removeClass("prototype"),r.find("[name=type]").val(e.type),r.find("[name=value]").val(n),a.append(r)}}e.find(".consequence-list .item-create").click(s=>{let i=e.find(".consequence.prototype"),a=e.find("ol.consequence-list");if(!i||!i.length||!a||!a.length)return;let n=i.clone();n.removeClass("prototype"),n.find(".item-delete").click(e=>$(e.currentTarget).closest(".consequence").remove()),a.append(n)}),e.find(".consequence-list .item-delete").click(e=>$(e.currentTarget).closest(".consequence").remove())},buttons:{Edit:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async e=>{i.success=e.find("input[name=success]").is(":checked"),i.critical=e.find("input[name=critical]").is(":checked"),i.margin=Number(e.find("input[name=margin]").val()),i.edited=!0;let a=[];e.find(".consequence:not(.prototype)").each((e,s)=>{let n=$(s).find("select[name=type]").val(),o=$(s).find("input[name=value]").val(),c={};if("consequence"===n)c.name=o.trim();else if("message"===n){let e=o.split(": ");e.length>=2?[c.key,c.value]=[e[0],e[1]]:[c.key,c.value]=["Message",e[0]]}else if("damage"===n){let e=o.split(" ");c.value=Number(e?.[0])-i.margin,c.damage_type=e?.[1],e.length>=3&&(c.properties=r.parse_properties(e.slice(2).join(" ")))}let d=new l({type:n,...c},i);d.apply(i.success?"success":"failure"),a.push(d),i.effects=a}),await ChatMessage.updateDocuments([{_id:s,content:i.content(),flavor:i.flavor()}],{})}}}}).render(!0)}})}async function el(e,s,i,a){game.user.id===a&&"character"===e.type&&await e.encumbrance_consequences(),game.user.id===a&&game.combat&&(game.user.isGM||e.isOwner)&&game.combat.update_combatant_initiative(e,s?.system?.fast_turn)}async function ec(e,s,i){game.user.id===i&&e.parent&&"character"===e.parent.type&&"item"===e.type&&await e.parent.encumbrance_consequences(),game.user.id===i&&e.parent&&"item"===e.type&&e.system.parent&&await e.remove_from_container(),game.user.id===i&&"consequence"===e.type&&e.parent&&await x(e.parent)}async function ed(e,s,i,a){game.user.id===a&&e.parent&&"character"===e.parent.type&&"item"===e.type&&await e.parent.encumbrance_consequences(),game.user.id===a&&"consequence"===e.type&&e.parent&&await x(e.parent)}async function eh(e,s,i){game.user.id===i&&e.parent&&"character"===e.parent.type&&"item"===e.type&&await e.parent.encumbrance_consequences(),game.user.id===i&&"consequence"===e.type&&e.parent&&await x(e.parent)}function eu(e,s,i,a){return game.user.id===a&&e.modifiesActor&&e.parent&&"character"===e.parent.type&&e.origin&&O(e),!0}async function ep(e,s,i){game.user.id===i&&!e.origin&&e.statuses?.size&&e.target&&await N(e),game.user.id===i&&!e.modifiesActor&&e.transfer&&e.parent&&e.parent.parent&&"character"===e.parent.parent.type&&await D(e.parent)}async function em(e,s,i,a){game.user.id===a&&!e.modifiesActor&&e.transfer&&e.parent&&e.parent.parent&&"character"===e.parent.parent.type&&await D(e.parent)}function eg(e,s,i){let a=!0;return game.user.id===i&&!e.origin&&e.statuses?.size&&(e?.flags?.system?.subject_prompt||e?.flags?.system?.value_prompt)&&(a&&=function(e){let s=e.target,i=s.items.filter(s=>s.name===e.name&&"consequence"===s.type);if(!i.length)return!0;if(i.length>1||e?.flags?.system?.value_prompt){let a='<form><div class="grid grid-2col">';return i.forEach(s=>{let i=e?.flags?.system?.value_prompt||s.system.rank>1?s.system.rank:"";a+=`<input type="radio" name="consequence" value="${s.id}" />
                            <label for="consequence">${s.system.full_name} ${i}</label>`}),a+="</div></form>",new Dialog({title:`Select Which ${i[0].name} to Remove`,content:a,buttons:{Confirm:{icon:"<i class='fa fa-trash'></i>",label:"Remove",callback:async e=>{let i=e.find("input[name=consequence]:checked").val();i&&await s.deleteEmbeddedDocuments("Item",[i])}}},default:"Confirm"}).render(!0),!1}return!0}(e)),a}async function ef(e,s,i){game.user.id===i&&!e.origin&&e.statuses?.size&&e.target&&await S(e),game.user.id===i&&!e.modifiesActor&&e.transfer&&e.parent&&e.parent.parent&&"character"===e.parent.parent.type&&await D(e.parent,!0)}async function ey(e,s,i,a){game.user.id===a&&s.round&&s.round!==e.round&&await e.start_of_round()}async function ev(e,s,i){await et(s,i)}async function e_(e,s,i){await ei(s)}async function eb(e,s,i){await ea(e,i)}async function ew(e,s){await en(s),await er(s),await eo(s)}const eT={name:"Starting Power Level",hint:"The starting power level of all player characters.",scope:"world",config:!0,type:Number,default:120,choices:{85:"Mundane",120:"Novice",160:"Exceptional",200:"Distinguished",240:"Renowned",280:"Legendary",146:"Shadows Over Sol"}},ek={name:"Name for Luck",hint:"Luck, Edge, Karma, Moxie, etc.",scope:"world",config:!0,type:String,default:"Luck",choices:{Luck:"Luck",Edge:"Edge",Karma:"Karma",Moxie:"Moxie"}},ex={name:"Starting Luck Affects Experience",hint:"Used in Shadows Over Sol",scope:"world",config:!0,type:Boolean,default:!1},eD={name:"Use Stress & Mental Breaks",hint:"This campaign uses the optional Stress rules.",scope:"world",config:!0,type:Boolean,default:!1};CONFIG.debug.hooks=!0,Hooks.once("init",async()=>{console.log("Initializing Saga Machine"),game.sagamachine={SagaMachineActor:C,SagaMachineItem:n,sm_test_macro:es},CONFIG.Actor.documentClass=C,CONFIG.Item.documentClass=n,CONFIG.Combatant.documentClass=u,CONFIG.Combat.documentClass=p,CONFIG.ui.combat=m,Actors.unregisterSheet("core",ActorSheet),Items.unregisterSheet("core",ItemSheet),Actors.registerSheet("saga-machine",j,{types:["character"],makeDefault:!0}),Actors.registerSheet("saga-machine",H,{types:["stash"],makeDefault:!0}),Actors.registerSheet("saga-machine",F,{types:["vehicle"],makeDefault:!0}),Items.registerSheet("saga-machine",G,{types:["skill"],makeDefault:!0}),Items.registerSheet("saga-machine",J,{types:["trait"],makeDefault:!0}),Items.registerSheet("saga-machine",K,{types:["origin"],makeDefault:!0}),Items.registerSheet("saga-machine",Y,{types:["path"],makeDefault:!0}),Items.registerSheet("saga-machine",X,{types:["consequence"],makeDefault:!0}),Items.registerSheet("saga-machine",Q,{types:["item"],makeDefault:!0}),Items.registerSheet("saga-machine",Z,{types:["ambition"],makeDefault:!0}),Items.registerSheet("saga-machine",ee,{types:["action"],makeDefault:!0}),CONFIG.statusEffects=T(),CONFIG.specialStatusEffects.DEFEATED="defeated",CONFIG.specialStatusEffects.INCAPACITATED="unconscious",CONFIG.specialStatusEffects.INVISIBLE="hidden",game.sagamachine.standard_consequences=CONFIG.statusEffects.map(e=>e.name),Hooks.on("updateActor",el),Hooks.on("createItem",ec),Hooks.on("updateItem",ed),Hooks.on("deleteItem",eh),Hooks.on("preCreateActiveEffect",eu),Hooks.on("createActiveEffect",ep),Hooks.on("updateActiveEffect",em),Hooks.on("preDeleteActiveEffect",eg),Hooks.on("deleteActiveEffect",ef),Hooks.on("preUpdateCombat",ey),Hooks.on("hotbarDrop",ev),Hooks.on("renderChatMessage",e_),Hooks.on("dropActorSheetData",eb),Hooks.on("getChatLogEntryContext",ew),game.settings.register("saga-machine","level",eT),game.settings.register("saga-machine","luck_label",ek),game.settings.register("saga-machine","luck_exp",ex),game.settings.register("saga-machine","stress",eD)});
//# sourceMappingURL=sagamachine.js.map
